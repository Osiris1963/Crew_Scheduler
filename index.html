<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crew Scheduling System - San Carlos Negros 688</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBlbxhzUp_TZd8oTrLxrY-E6gq-_XdiMCo",
        authDomain: "mcdonalds-san-carlos.firebaseapp.com",
        projectId: "mcdonalds-san-carlos",
        storageBucket: "mcdonalds-san-carlos.firebasestorage.app",
        messagingSenderId: "1052052612983",
        appId: "1:1052052612983:web:8df02d65d12e99e0666372",
        measurementId: "G-EYSWHXTQ6F"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a2e; }
        ::-webkit-scrollbar-thumb { background: #4a4a6e; border-radius: 4px; }
        
        body { font-family: 'DM Sans', sans-serif; background: #0f0f1a; color: #fff; min-height: 100vh; }
        
        /* Login Screen Styles */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #0f0f1a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .login-screen.hidden { display: none; }
        
        .login-container {
            background: linear-gradient(135deg, #1a1a2e 0%, #12121f 100%);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #ee7410 0%, #ff9500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .login-header p {
            color: #888;
            font-size: 14px;
        }
        
        .login-form .form-group {
            margin-bottom: 20px;
        }
        
        .login-form label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #888;
            margin-bottom: 8px;
        }
        
        .login-form input {
            width: 100%;
            padding: 14px 16px;
            background: #0f0f1a;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .login-form input:focus {
            outline: none;
            border-color: #ee7410;
            box-shadow: 0 0 0 3px rgba(238,116,16,0.2);
        }
        
        .login-form input::placeholder {
            color: #555;
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #ee7410 0%, #ff9500 100%);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(238,116,16,0.4);
        }
        
        .login-error {
            background: rgba(239,68,68,0.1);
            border: 1px solid rgba(239,68,68,0.3);
            color: #ef4444;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 20px;
            display: none;
        }
        
        .login-error.show { display: block; }
        
        .login-footer {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .login-footer p {
            color: #555;
            font-size: 12px;
        }
        
        /* App container - hidden until logged in */
        .app-container { display: none; }
        
        /* Login error - hidden by default */
        .login-error { display: none; }
        
        .sidebar { position: fixed; left: 0; top: 0; width: 240px; height: 100vh; background: linear-gradient(180deg, #1a1a2e 0%, #12121f 100%); border-right: 1px solid rgba(255,255,255,0.1); z-index: 100; display: flex; flex-direction: column; }
        .logo { padding: 20px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo-icon { width: 45px; height: 45px; background: linear-gradient(135deg, #da291c 0%, #ff2d1a 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 4px 15px rgba(218,41,28,0.3); }
        .logo-text h1 { font-size: 15px; font-weight: 700; }
        .logo-text p { font-size: 11px; color: #888; margin-top: 2px; }
        
        .nav { flex: 1; padding: 15px; overflow-y: auto; }
        .nav-section { margin-bottom: 20px; }
        .nav-section-title { font-size: 10px; text-transform: uppercase; color: #555; letter-spacing: 1px; padding: 0 12px; margin-bottom: 8px; }
        .nav-btn { width: 100%; display: flex; align-items: center; gap: 12px; padding: 12px 15px; border: none; background: transparent; color: #888; font-size: 13px; text-align: left; cursor: pointer; border-radius: 10px; transition: all 0.2s; margin-bottom: 4px; }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-btn.active { background: linear-gradient(135deg, rgba(238,116,16,0.2) 0%, rgba(238,116,16,0.1) 100%); color: #ee7410; border: 1px solid rgba(238,116,16,0.3); }
        .nav-btn svg { width: 20px; height: 20px; flex-shrink: 0; }
        
        .main { margin-left: 240px; min-height: 100vh; }
        
        .header { position: sticky; top: 0; z-index: 50; padding: 15px 25px; background: rgba(15,15,26,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; }
        .header-left h2 { font-size: 22px; font-weight: 700; }
        .header-left p { font-size: 12px; color: #666; margin-top: 3px; }
        .header-controls { display: flex; align-items: center; gap: 12px; }
        .header-controls input, .header-controls select { padding: 10px 14px; background: #1a1a2e; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 13px; }
        
        .btn { padding: 10px 18px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: linear-gradient(135deg, #ee7410 0%, #ff9500 100%); color: #fff; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: #fff; }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: #fff; }
        .btn-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: #fff; }
        .btn-sm { padding: 6px 12px; font-size: 11px; }
        
        .content { padding: 25px; }
        
        .cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .card { background: linear-gradient(135deg, #1a1a2e 0%, #12121f 100%); border-radius: 16px; padding: 22px; border: 1px solid rgba(255,255,255,0.08); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .card-header span { font-size: 13px; color: #888; }
        .card-icon { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .card h3 { font-size: 32px; font-weight: 700; }
        .card p { font-size: 12px; color: #555; }
        
        .panel { background: linear-gradient(135deg, #1a1a2e 0%, #12121f 100%); border-radius: 16px; border: 1px solid rgba(255,255,255,0.08); overflow: hidden; margin-bottom: 25px; }
        .panel-header { padding: 18px 22px; border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .panel-header h3 { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .panel-body { padding: 20px; }
        .panel-scroll { max-height: calc(100vh - 300px); overflow: auto; }
        
        /* NPG Area Sections */
        .npg-area { margin-bottom: 25px; background: rgba(0,0,0,0.2); border-radius: 12px; overflow: hidden; }
        .npg-area-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; }
        .npg-area-header:hover { background: rgba(255,255,255,0.03); }
        .npg-area-header h4 { font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .npg-area-header .area-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .npg-area-header .station-count { font-size: 11px; color: #888; background: rgba(255,255,255,0.1); padding: 3px 10px; border-radius: 20px; }
        .npg-area-body { padding: 0 20px 20px; display: none; }
        .npg-area.expanded .npg-area-body { display: block; }
        .npg-area-header .toggle-icon { transition: transform 0.2s; }
        .npg-area.expanded .toggle-icon { transform: rotate(180deg); }
        
        /* NPG Table */
        .npg-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .npg-table th, .npg-table td { border: 1px solid #2a2a4a; padding: 8px 10px; text-align: center; }
        .npg-table th { background: #2d4a7c; color: #fff; font-weight: 600; }
        .npg-table th.gc-range { background: #1e3a5f; font-size: 10px; }
        .npg-table td { background: #1a1a2e; }
        .npg-table td.station-name { text-align: left; font-weight: 500; padding-left: 15px; }
        .npg-table input { width: 40px; padding: 5px; background: #12121f; border: 1px solid #333; border-radius: 4px; color: #fff; text-align: center; font-size: 12px; }
        .npg-table input:focus { outline: none; border-color: #ee7410; }
        .npg-table .delete-btn { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 16px; opacity: 0.6; }
        .npg-table .delete-btn:hover { opacity: 1; }
        
        /* Area Colors */
        .area-production .npg-area-header { background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(220,38,38,0.1)); border-left: 4px solid #ef4444; }
        .area-service .npg-area-header { background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(37,99,235,0.1)); border-left: 4px solid #3b82f6; }
        .area-bevcel_fries .npg-area-header { background: linear-gradient(135deg, rgba(249,115,22,0.2), rgba(234,88,12,0.1)); border-left: 4px solid #f97316; }
        .area-drivethru .npg-area-header { background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(5,150,105,0.1)); border-left: 4px solid #10b981; }
        .area-mds .npg-area-header { background: linear-gradient(135deg, rgba(168,85,247,0.2), rgba(139,92,246,0.1)); border-left: 4px solid #a855f7; }
        .area-marketing .npg-area-header { background: linear-gradient(135deg, rgba(251,191,36,0.2), rgba(245,158,11,0.1)); border-left: 4px solid #fbbf24; }
        .area-others .npg-area-header { background: linear-gradient(135deg, rgba(107,114,128,0.2), rgba(75,85,99,0.1)); border-left: 4px solid #6b7280; }
        
        /* Schedule Table */
        .schedule-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .schedule-table th, .schedule-table td { border: 1px solid #2a2a4a; padding: 6px 8px; text-align: center; white-space: nowrap; }
        .schedule-table thead { position: sticky; top: 0; z-index: 10; }
        .schedule-table th { background: linear-gradient(135deg, #2d4a7c 0%, #1e3a5f 100%); color: #fff; font-weight: 600; }
        .schedule-table th.name-col { min-width: 130px; text-align: left; position: sticky; left: 0; z-index: 15; }
        .schedule-table th.hour-col { min-width: 26px; width: 26px; padding: 6px 3px; font-size: 10px; }
        .schedule-table .section-row td { background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%) !important; color: #000 !important; font-weight: 700; text-align: left !important; padding-left: 15px !important; }
        .schedule-table td.name-cell { text-align: left; font-weight: 500; background: #1a1a2e; position: sticky; left: 0; z-index: 5; }
        .schedule-table td.station-cell { font-size: 10px; color: #888; background: #15152a; }
        .schedule-table td.total-cell { background: rgba(16,185,129,0.15); color: #10b981; font-weight: 700; }
        .schedule-table td.meal-cell.meal-a { color: #f87171; background: rgba(248,113,113,0.1); }
        .schedule-table td.meal-cell.meal-b { color: #60a5fa; background: rgba(96,165,250,0.1); }
        .hour-cell { padding: 0 !important; background: #12121f; }
        .hour-cell.filled { background: linear-gradient(135deg, rgba(16,185,129,0.3) 0%, rgba(5,150,105,0.2) 100%) !important; }
        .hour-cell input { width: 100%; height: 26px; border: none; background: transparent; text-align: center; color: #fff; font-size: 10px; cursor: pointer; }
        .hour-cell.filled input { color: #4ade80; }
        .schedule-table .summary-row td { background: linear-gradient(135deg, #2d4a7c 0%, #1e3a5f 100%); color: #fff; font-weight: 700; }
        .schedule-table .gc-row td { background: rgba(238,116,16,0.2); color: #ee7410; font-weight: 600; }
        
        /* Rest Calendar */
        .rest-table th.weekend { background: #7c4a2d; }
        .rest-table td.rest-day { background: linear-gradient(135deg, #10b981, #059669); color: #fff; font-weight: 700; }
        .rest-table td.weekend { background: rgba(255,193,7,0.1); }
        
        /* Quick Actions */
        .quick-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .action-card { background: linear-gradient(135deg, #1a1a2e 0%, #12121f 100%); border-radius: 14px; padding: 20px; border: 1px solid rgba(255,255,255,0.08); cursor: pointer; transition: all 0.3s; }
        .action-card:hover { transform: translateY(-3px); border-color: rgba(238,116,16,0.3); }
        .action-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 12px; }
        .action-card h4 { font-size: 15px; margin-bottom: 5px; }
        .action-card p { font-size: 12px; color: #666; }
        
        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: linear-gradient(135deg, #1a1a2e 0%, #12121f 100%); border-radius: 20px; padding: 30px; width: 95%; max-width: 900px; border: 1px solid rgba(255,255,255,0.1); max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { font-size: 20px; }
        .modal-close { background: none; border: none; color: #888; font-size: 28px; cursor: pointer; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 13px; color: #888; margin-bottom: 6px; }
        .form-group input, .form-group select { width: 100%; padding: 10px 14px; background: #12121f; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #ee7410; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        /* GC Input Grid */
        .gc-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin: 20px 0; }
        .gc-item { background: #12121f; border-radius: 8px; padding: 12px; text-align: center; border: 1px solid #333; }
        .gc-item label { display: block; font-size: 11px; color: #888; margin-bottom: 6px; }
        .gc-item input { width: 100%; padding: 10px; background: #1a1a2e; border: 1px solid #444; border-radius: 6px; color: #fff; font-size: 16px; font-weight: 700; text-align: center; }
        
        /* Add Station Form */
        .add-station-form { display: flex; gap: 10px; margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; }
        .add-station-form input { flex: 1; padding: 10px; background: #12121f; border: 1px solid #333; border-radius: 6px; color: #fff; }
        
        /* Print Styles - Maintains colors */
        @media print {
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }
            
            .sidebar, .header, .btn, .modal, .quick-actions, .cards { display: none !important; }
            .main { margin-left: 0 !important; padding: 0 !important; }
            .content { padding: 10px !important; }
            .panel { background: #fff !important; border: 1px solid #333 !important; margin: 0 !important; }
            .panel-header { background: #1a1a2e !important; color: #fff !important; padding: 10px !important; }
            .panel-header h3 { color: #fff !important; font-size: 14px !important; }
            
            /* Hide non-essential elements in Daily Schedule */
            #daily-section .panel-header > div { display: none !important; }
            #daily-section > .panel > div:nth-child(2),
            #daily-section > .panel > div:nth-child(3) { display: none !important; }
            
            /* Table styling */
            .schedule-table { font-size: 8px !important; }
            .schedule-table th { background: #1e293b !important; color: #fff !important; padding: 4px 2px !important; font-size: 7px !important; }
            .schedule-table td { padding: 3px 2px !important; font-size: 8px !important; border: 1px solid #444 !important; }
            .schedule-table .name-cell { font-size: 9px !important; font-weight: bold !important; }
            
            /* Section rows */
            .section-row td { background: #f97316 !important; color: #fff !important; font-weight: bold !important; font-size: 9px !important; }
            
            /* GC Row */
            .gc-row td { background: #fbbf24 !important; color: #000 !important; font-weight: bold !important; }
            
            /* Filled hours - Green background */
            .hour-cell.filled { background: #10b981 !important; }
            .hour-cell.filled input { color: #fff !important; background: transparent !important; }
            
            /* Summary row */
            .summary-row td { background: #1e293b !important; color: #fff !important; font-weight: bold !important; }
            
            /* Total cell */
            .total-cell { background: rgba(59,130,246,0.2) !important; font-weight: bold !important; }
            
            /* Meal cells */
            .meal-a { background: #10b981 !important; color: #fff !important; }
            .meal-b { background: #3b82f6 !important; color: #fff !important; }
            
            /* Hide inputs, show values */
            .schedule-table input { border: none !important; background: transparent !important; text-align: center !important; font-size: 8px !important; }
            
            /* Page setup */
            @page { size: landscape; margin: 0.25in; }
            
            /* Graveyard hours background */
            .hour-col[title="Graveyard"], .hour-col[title="Graveyard + Breakfast"] { background: #1e293b !important; color: #94a3b8 !important; }
            
            /* Breakfast hours background */
            .hour-col[title="Breakfast"] { background: #92400e !important; color: #fbbf24 !important; }
        }
    </style>
</head>
<body>
    <script>
    // Login function - defined early so it's available when button is clicked
    function doLogin() {
        const username = document.getElementById('loginUsername').value.trim().toLowerCase();
        const password = document.getElementById('loginPassword').value;
        const errorEl = document.getElementById('loginError');
        
        // Get users from localStorage or use defaults
        let users;
        try {
            const savedUsers = localStorage.getItem('crewSchedulerUsers');
            users = savedUsers ? JSON.parse(savedUsers) : {
                'admin': { password: 'admin123', role: 'admin', name: 'Administrator' },
                'manager': { password: 'manager123', role: 'manager', name: 'Store Manager' },
                'crew': { password: 'crew123', role: 'crew', name: 'Crew Member' }
            };
        } catch(e) {
            users = {
                'admin': { password: 'admin123', role: 'admin', name: 'Administrator' },
                'manager': { password: 'manager123', role: 'manager', name: 'Store Manager' },
                'crew': { password: 'crew123', role: 'crew', name: 'Crew Member' }
            };
        }
        
        // Check credentials
        if(users[username] && users[username].password === password) {
            const currentUser = {
                username: username,
                role: users[username].role,
                name: users[username].name
            };
            
            // Save session
            localStorage.setItem('crewSchedulerSession', JSON.stringify(currentUser));
            
            // Hide login, show app
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            
            // Initialize app if init function exists
            if(typeof init === 'function') {
                init();
            }
        } else {
            // Show error
            errorEl.style.display = 'block';
            document.getElementById('loginPassword').value = '';
            
            // Hide error after 3 seconds
            setTimeout(function() { errorEl.style.display = 'none'; }, 3000);
        }
    }
    </script>
    
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <h1>Crew Scheduler</h1>
                <p>San Carlos Negros - 688</p>
            </div>
            
            <div class="login-error" id="loginError">
                Invalid username or password. Please try again.
            </div>
            
            <div class="login-form">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter your username" autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" autocomplete="current-password" onkeypress="if(event.key==='Enter')doLogin()">
                </div>
                
                <button type="button" class="login-btn" onclick="doLogin()">üîê Sign In</button>
            </div>
            
            <div class="login-footer">
                <p>¬© 2026 McDonald's San Carlos Negros - 688</p>
            </div>
        </div>
    </div>

    <!-- App Container (hidden until logged in) -->
    <div class="app-container" id="appContainer">
    
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <div class="logo-text">
                <h1>Crew Scheduler</h1>
                <p>San Carlos Negros - 688</p>
            </div>
        </div>
        
        <nav class="nav">
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                <button class="nav-btn active" onclick="showSection('dashboard')" data-section="dashboard">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                    Dashboard
                </button>
                <button class="nav-btn" onclick="showSection('daily')" data-section="daily">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    Crew Scheduling
                </button>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Configuration</div>
                <button class="nav-btn" onclick="showSection('npg')" data-section="npg">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                    Positioning Guide (NPG)
                </button>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Planning</div>
                <button class="nav-btn" onclick="showSection('monthly')" data-section="monthly">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    Monthly Rotation
                </button>
                <button class="nav-btn" onclick="showSection('rest')" data-section="rest">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                    Rest Calendar
                </button>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Management</div>
                <button class="nav-btn" onclick="showSection('crew')" data-section="crew">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                    Crew Masterlist
                </button>
                <button class="nav-btn" onclick="showSection('reports')" data-section="reports">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    Reports
                </button>
            </div>
        </nav>
        
        <!-- Logout Section -->
        <div style="padding: 15px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto;">
            <button class="nav-btn" onclick="openChangePassword()" style="margin-bottom: 8px;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                Change Password
            </button>
            <button class="nav-btn" onclick="logout()" style="background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #ef4444;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                Logout
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
        <header class="header">
            <div class="header-left">
                <h2 id="pageTitle">Dashboard</h2>
                <p id="pageSubtitle">Overview of crew scheduling</p>
            </div>
            <div class="header-controls">
                <input type="date" id="dateSelect" value="2025-08-01">
                <select id="monthSelect"></select>
                <select id="yearSelect"></select>
            </div>
        </header>

        <div class="content">
            <!-- Dashboard Section -->
            <section id="dashboard-section">
                <!-- Summary Cards -->
                <div class="cards">
                    <div class="card">
                        <div class="card-header"><span>Total Crew</span><div class="card-icon" style="background:rgba(238,116,16,0.15);color:#ee7410;">üë•</div></div>
                        <h3 id="statTotalCrew">0</h3>
                        <p>Active crew members</p>
                    </div>
                    <div class="card">
                        <div class="card-header"><span>Scheduled Today</span><div class="card-icon" style="background:rgba(16,185,129,0.15);color:#10b981;">‚úì</div></div>
                        <h3 id="statScheduledToday">0</h3>
                        <p>On duty today</p>
                    </div>
                    <div class="card">
                        <div class="card-header"><span>Available Crew</span><div class="card-icon" style="background:rgba(59,130,246,0.15);color:#3b82f6;">üôã</div></div>
                        <h3 id="statAvailableCrew">0</h3>
                        <p>Ready to be called</p>
                    </div>
                    <div class="card">
                        <div class="card-header"><span>On Rest</span><div class="card-icon" style="background:rgba(251,191,36,0.15);color:#fbbf24;">üò¥</div></div>
                        <h3 id="statOnRest">0</h3>
                        <p>Rest day today</p>
                    </div>
                </div>
                
                <!-- Available Crew Panel -->
                <div class="panel" style="margin-top:20px;">
                    <div class="panel-header">
                        <h3>üôã Available Crew for Today</h3>
                        <span id="availableCrewDate" style="color:#888;font-size:12px;">January 30, 2026</span>
                    </div>
                    <div class="panel-body">
                        <p style="color:#888;font-size:11px;margin-bottom:15px;">
                            Crew members who are <strong>NOT scheduled</strong> today, <strong>NOT on rest</strong>, and are <strong>available</strong> based on their time availability. 
                            Perfect for finding replacements when someone is absent.
                        </p>
                        
                        <div id="availableCrewList" style="max-height:400px;overflow-y:auto;">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>
                </div>
                
                <div class="panel" style="margin-top:20px;">
                    <div class="panel-header"><h3>üìä Today's Schedule by Area</h3></div>
                    <div class="panel-body" id="todayOverview"></div>
                </div>
            </section>

            <!-- NPG Section -->
            <section id="npg-section" style="display:none;">
                <div class="panel">
                    <div class="panel-header">
                        <h3>‚öôÔ∏è Number Positioning Guide (NPG)</h3>
                        <div style="display:flex;gap:10px;">
                            <button class="btn btn-secondary btn-sm" onclick="resetAllData()">üîÑ Reset Data</button>
                            <button class="btn btn-info" onclick="openAddStationModal()">‚ûï Add Station</button>
                            <button class="btn btn-primary" onclick="saveNPG()">üíæ Save NPG</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <p style="color:#888;margin-bottom:20px;">Define how many crew members are needed per station based on Guest Count (GC) ranges. Click on each area to expand/collapse.</p>
                        <div id="npgAreas"></div>
                    </div>
                </div>
            </section>

            <!-- Crew Scheduling Section -->
            <section id="daily-section" style="display:none;">
                <div class="panel">
                    <div class="panel-header">
                        <h3>üìã Crew Scheduling - <span id="scheduleDate">August 1, 2025</span></h3>
                        <div style="display:flex;gap:10px;align-items:center;">
                            <span id="scheduleLockStatus" style="font-size:11px;padding:5px 10px;border-radius:4px;background:#10b981;color:#fff;display:none;">üîí Locked</span>
                            <button class="btn btn-secondary" onclick="prevDay()">‚Üê Prev</button>
                            <button class="btn btn-secondary" onclick="nextDay()">Next ‚Üí</button>
                            <button class="btn btn-danger" id="btnResetSchedule" onclick="resetDailySchedule()" style="background:#ef4444;">üóëÔ∏è Reset</button>
                            <button class="btn btn-success" id="btnAutoFill" onclick="openAutoFillModal()">ü§ñ Auto-Fill with GC</button>
                            <button class="btn btn-primary" id="btnSaveSchedule" onclick="saveDailySchedule()" style="background:#3b82f6;">üíæ Save</button>
                            <button class="btn btn-warning" id="btnEditSchedule" onclick="editDailySchedule()" style="background:#f97316;display:none;">‚úèÔ∏è Edit</button>
                            <div style="border-left:1px solid #444;height:24px;margin:0 5px;"></div>
                            <button class="btn btn-info" onclick="downloadScheduleExcel()" style="background:#059669;">üì• Download Excel</button>
                        </div>
                    </div>
                    
                    <!-- Sales/GC/Labor Calculator -->
                    <!-- Date and Sales Info Bar -->
                    <div style="background:linear-gradient(135deg,#1e3a5f,#1a1a2e);padding:12px 15px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #333;">
                        <div style="display:flex;align-items:center;gap:15px;">
                            <span style="font-size:20px;">üìÖ</span>
                            <div>
                                <div id="scheduleDateFull" style="font-size:18px;font-weight:bold;color:#fff;">Thursday, January 30, 2026</div>
                                <div id="scheduleDateSub" style="font-size:11px;color:#888;">Crew Schedule for this date</div>
                            </div>
                        </div>
                        <div style="display:flex;gap:20px;align-items:center;">
                            <div style="text-align:right;">
                                <div style="font-size:10px;color:#888;">Day of Week</div>
                                <div id="dayOfWeek" style="font-size:14px;font-weight:bold;color:#fbbf24;">Thursday</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sales/GC/Labor Calculator - 7 columns now -->
                    <div style="background:rgba(0,0,0,0.3);padding:15px;display:grid;grid-template-columns:repeat(7,1fr);gap:12px;align-items:end;">
                        <div>
                            <label style="font-size:10px;color:#888;display:block;margin-bottom:5px;">üí∞ Gross Sales</label>
                            <input type="number" id="grossSales" placeholder="0.00" 
                                onchange="calculateNetSales(); calculateLaborMetrics()"
                                oninput="calculateNetSales(); calculateLaborMetrics()"
                                style="width:100%;padding:10px;background:#1a1a2e;border:1px solid #10b981;border-radius:6px;color:#10b981;font-size:16px;font-weight:bold;">
                        </div>
                        <div>
                            <label style="font-size:10px;color:#888;display:block;margin-bottom:5px;">üíµ Net Sales <span style="font-size:8px;color:#666;">(√∑1.12)</span></label>
                            <input type="text" id="netSales" readonly placeholder="0.00"
                                style="width:100%;padding:10px;background:#12121f;border:1px solid #333;border-radius:6px;color:#22c55e;font-size:16px;font-weight:bold;">
                        </div>
                        <div>
                            <label style="font-size:10px;color:#888;display:block;margin-bottom:5px;">üë• Total GC</label>
                            <input type="number" id="totalGCInput" placeholder="0" readonly
                                style="width:100%;padding:10px;background:#12121f;border:1px solid #333;border-radius:6px;color:#fbbf24;font-size:16px;font-weight:bold;">
                        </div>
                        <div>
                            <label style="font-size:10px;color:#888;display:block;margin-bottom:5px;">‚è±Ô∏è Labor Hours</label>
                            <input type="text" id="totalLaborHours" readonly
                                style="width:100%;padding:10px;background:#12121f;border:1px solid #333;border-radius:6px;color:#3b82f6;font-size:16px;font-weight:bold;">
                        </div>
                        <div>
                            <label style="font-size:10px;color:#888;display:block;margin-bottom:5px;">üíµ Labor Cost</label>
                            <input type="text" id="laborCostEst" readonly
                                style="width:100%;padding:10px;background:#12121f;border:1px solid #333;border-radius:6px;color:#f97316;font-size:16px;font-weight:bold;">
                        </div>
                        <div>
                            <label style="font-size:10px;color:#888;display:block;margin-bottom:5px;">üìä Labor %</label>
                            <input type="text" id="laborPercent" readonly
                                style="width:100%;padding:10px;background:#12121f;border:1px solid #333;border-radius:6px;color:#ef4444;font-size:16px;font-weight:bold;">
                        </div>
                        <div>
                            <label style="font-size:10px;color:#888;display:block;margin-bottom:5px;">üåô Night Premium</label>
                            <input type="text" id="nightPremium" readonly title="10% premium for 10PM-6AM hours"
                                style="width:100%;padding:10px;background:#12121f;border:1px solid #333;border-radius:6px;color:#8b5cf6;font-size:16px;font-weight:bold;">
                        </div>
                    </div>
                    <div style="background:rgba(0,0,0,0.2);padding:8px 15px;font-size:10px;color:#666;">
                        üí° <strong>Net Sales</strong> = Gross Sales √∑ 1.12 (VAT removed). <strong>Labor %</strong> = Labor Cost √∑ Net Sales √ó 100.
                        <span style="float:right;">Default Rate: ‚Ç±<input type="number" id="hourlyRate" value="62.50" min="0" step="0.50" onchange="calculateLaborMetrics()" style="width:60px;background:#1a1a2e;border:1px solid #333;color:#fff;padding:2px 5px;border-radius:3px;"> (for manual entries)</span>
                    </div>
                    
                    <div class="panel-scroll">
                        <table class="schedule-table" id="dailyTable">
                            <thead id="dailyHead"></thead>
                            <tbody id="dailyBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Monthly Section -->
            <section id="monthly-section" style="display:none;">
                <div class="panel">
                    <div class="panel-header">
                        <h3>üìÖ Monthly Job Rotation & Duty Streak Tracker</h3>
                        <div style="display:flex;gap:10px;align-items:center;">
                            <button class="btn btn-warning" onclick="openAutoRestModal()" style="background:#fbbf24;color:#000;">ü§ñ Auto Rest Suggestion</button>
                        </div>
                    </div>
                    <div style="padding:10px 15px;background:rgba(0,0,0,0.2);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                        <p style="color:#888;font-size:11px;margin:0;">
                            ‚ö†Ô∏è <strong>Duty Streak Alert:</strong> Crew must not exceed 6 consecutive duty days to avoid 7th day pay. 
                            <strong style="color:#fbbf24;">5th day</strong> = Warning | 
                            <strong style="color:#f97316;">6th day</strong> = Must rest next | 
                            <strong style="color:#ef4444;">7th+ day</strong> = Violation!
                        </p>
                        <div style="font-size:10px;display:flex;gap:15px;">
                            <span style="display:flex;align-items:center;gap:4px;"><span style="width:12px;height:12px;background:#10b981;border-radius:2px;"></span> 1-4 days</span>
                            <span style="display:flex;align-items:center;gap:4px;"><span style="width:12px;height:12px;background:#fbbf24;border-radius:2px;"></span> 5th day</span>
                            <span style="display:flex;align-items:center;gap:4px;"><span style="width:12px;height:12px;background:#f97316;border-radius:2px;"></span> 6th day</span>
                            <span style="display:flex;align-items:center;gap:4px;"><span style="width:12px;height:12px;background:#ef4444;border-radius:2px;"></span> 7th+ day ‚ö†Ô∏è</span>
                        </div>
                    </div>
                    <!-- Summary Stats -->
                    <div id="monthlyStats" style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;padding:15px;background:rgba(0,0,0,0.3);"></div>
                    <div class="panel-scroll">
                        <table class="schedule-table" id="monthlyTable"><thead id="monthlyHead"></thead><tbody id="monthlyBody"></tbody></table>
                    </div>
                </div>
            </section>

            <!-- Rest Calendar Section -->
            <section id="rest-section" style="display:none;">
                <div class="panel">
                    <div class="panel-header">
                        <h3>üåô Rest Day Calendar</h3>
                        <div style="display:flex;gap:10px;">
                            <button class="btn btn-secondary" onclick="saveRestData()">üíæ Save Rest Days</button>
                            <button class="btn btn-info" onclick="clearAllRest()">üóëÔ∏è Clear All</button>
                        </div>
                    </div>
                    <p style="padding:10px 15px;color:#888;font-size:11px;background:rgba(0,0,0,0.2);margin:0;">
                        üìù Click on a cell to toggle rest day. <strong style="color:#ef4444;">R</strong> = Rest Day (crew cannot be scheduled). Crew on rest will be excluded from Auto-Fill.
                    </p>
                    <div class="panel-scroll">
                        <table class="schedule-table rest-table" id="restTable"><thead id="restHead"></thead><tbody id="restBody"></tbody></table>
                    </div>
                </div>
            </section>

            <!-- Crew Masterlist Section -->
            <section id="crew-section" style="display:none;">
                <div class="panel">
                    <div class="panel-header">
                        <h3>üë• Crew Masterlist</h3>
                        <div style="display:flex;gap:10px;">
                            <button class="btn btn-secondary" onclick="saveCrewData()">üíæ Save Changes</button>
                            <button class="btn btn-primary" onclick="openAddCrewModal()">‚ûï Add Crew</button>
                        </div>
                    </div>
                    <p style="padding:10px 15px;color:#888;font-size:11px;background:rgba(0,0,0,0.2);margin:0;">
                        üìù Click on any cell to edit. <strong>12AM-12AM</strong> = Available 24 hours. Leave blank or type <strong>OFF</strong> for unavailable days.
                    </p>
                    <!-- Bulk Rate Apply Section -->
                    <div style="padding:10px 15px;background:rgba(16,185,129,0.1);border-bottom:1px solid #333;display:flex;align-items:center;gap:15px;flex-wrap:wrap;">
                        <span style="font-size:11px;color:#10b981;font-weight:600;">üí∞ Bulk Rate Update:</span>
                        <div style="display:flex;align-items:center;gap:5px;">
                            <span style="font-size:11px;color:#888;">‚Ç±</span>
                            <input type="number" id="bulkRateInput" value="62.50" min="0" step="0.50" 
                                style="width:80px;padding:6px;background:#1a1a2e;border:1px solid #10b981;border-radius:4px;color:#10b981;font-size:12px;font-weight:bold;">
                            <span style="font-size:11px;color:#888;">/hr</span>
                        </div>
                        <button type="button" onclick="applyRateToSelected()" class="btn btn-sm" style="padding:5px 12px;font-size:10px;background:#3b82f6;color:#fff;border:none;border-radius:4px;cursor:pointer;">Apply to Selected</button>
                        <button type="button" onclick="applyRateToAll()" class="btn btn-sm" style="padding:5px 12px;font-size:10px;background:#f97316;color:#fff;border:none;border-radius:4px;cursor:pointer;">Apply to All</button>
                        <span id="selectedCount" style="font-size:10px;color:#888;margin-left:auto;">0 selected</span>
                    </div>
                    <div class="panel-scroll">
                        <table class="schedule-table" id="crewTable">
                            <thead><tr>
                                <th style="width:30px;"><input type="checkbox" id="selectAllCrew" onchange="toggleSelectAllCrew(this)" title="Select All"></th>
                                <th class="name-col">Name</th>
                                <th style="width:100px;">Position</th>
                                <th style="width:80px;">Status</th>
                                <th style="width:90px;">Shift Pref</th>
                                <th style="width:80px;">Rate/Hr</th>
                                <th style="min-width:160px;">Stations Trained</th>
                                <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
                                <th style="width:60px;">Actions</th>
                            </tr></thead>
                            <tbody id="crewBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports-section" style="display:none;">
                <div class="panel">
                    <div class="panel-header"><h3>üìä Monthly Report</h3></div>
                    <div class="panel-scroll">
                        <table class="schedule-table" id="reportTable">
                            <thead><tr><th class="name-col">Name</th><th>Section</th><th>Total Hours</th><th>Days Worked</th><th>Rest Days</th><th>Avg Hrs/Day</th></tr></thead>
                            <tbody id="reportBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Auto-Fill Modal -->
    <div class="modal" id="autoFillModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ü§ñ Auto-Fill Schedule with GC Forecast</h3>
                <button class="modal-close" onclick="closeModal('autoFillModal')">&times;</button>
            </div>
            
            <p style="color:#888;margin-bottom:15px;">Enter the projected Guest Count (GC) for each hour. The system will use the NPG to determine crew positioning.</p>
            
            <div class="form-group">
                <label>Date to Schedule</label>
                <input type="date" id="autoFillDate" value="2025-08-01">
            </div>
            
            <!-- Duty Hours Settings -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;">
                <div style="background:#12121f;padding:15px;border-radius:10px;border:1px solid #333;">
                    <label style="font-size:12px;color:#888;display:block;margin-bottom:8px;">‚è±Ô∏è Minimum Duty Hours</label>
                    <input type="number" id="minDutyHours" value="4" min="1" max="12" 
                        style="width:100%;padding:12px;background:#1a1a2e;border:1px solid #444;border-radius:8px;color:#10b981;font-size:20px;font-weight:700;text-align:center;">
                    <p style="font-size:10px;color:#666;margin-top:5px;text-align:center;">Shortest shift allowed</p>
                </div>
                <div style="background:#12121f;padding:15px;border-radius:10px;border:1px solid #333;">
                    <label style="font-size:12px;color:#888;display:block;margin-bottom:8px;">‚è±Ô∏è Maximum Duty Hours</label>
                    <input type="number" id="maxDutyHours" value="8" min="4" max="12" 
                        style="width:100%;padding:12px;background:#1a1a2e;border:1px solid #444;border-radius:8px;color:#ee7410;font-size:20px;font-weight:700;text-align:center;">
                    <p style="font-size:10px;color:#666;margin-top:5px;text-align:center;">Longest shift allowed</p>
                </div>
            </div>
            
            <h4 style="margin-bottom:10px;color:#fbbf24;">üìä Hourly GC Forecast</h4>
            <div class="gc-grid" id="gcInputGrid"></div>
            
            <div style="display:flex;gap:10px;margin-top:20px;">
                <button class="btn btn-secondary" onclick="closeModal('autoFillModal')" style="flex:1;">Cancel</button>
                <button class="btn btn-success" onclick="runAutoFill()" style="flex:1;">ü§ñ Generate Schedule</button>
            </div>
        </div>
    </div>

    <!-- Add Station Modal -->
    <div class="modal" id="addStationModal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                <h3>‚ûï Add New Station</h3>
                <button class="modal-close" onclick="closeModal('addStationModal')">&times;</button>
            </div>
            
            <div class="form-group">
                <label>Station Name</label>
                <input type="text" id="newStationName" placeholder="e.g., Runner, Kitchen Helper">
            </div>
            
            <div class="form-group">
                <label>Area</label>
                <select id="newStationArea">
                    <option value="production">üî¥ Production</option>
                    <option value="service">üîµ Service Areas</option>
                    <option value="bevcel_fries">üü† Bevcel & Fries</option>
                    <option value="drivethru">üü¢ Drive Thru Area</option>
                    <option value="mds">üü£ MDS/3PO Area</option>
                    <option value="marketing">üü° Marketing</option>
                    <option value="others">‚ö™ Others</option>
                </select>
            </div>
            
            <div style="display:flex;gap:10px;margin-top:20px;">
                <button class="btn btn-secondary" onclick="closeModal('addStationModal')" style="flex:1;">Cancel</button>
                <button class="btn btn-primary" onclick="addNewStation()" style="flex:1;">Add Station</button>
            </div>
        </div>
    </div>

    <!-- Add Crew Modal -->
    <div class="modal" id="addCrewModal">
        <div class="modal-content" style="max-width:600px;">
            <div class="modal-header">
                <h3>‚ûï Add New Crew Member</h3>
                <button class="modal-close" onclick="closeModal('addCrewModal')">&times;</button>
            </div>
            
            <div class="form-group">
                <label>Crew Name</label>
                <input type="text" id="newCrewName" placeholder="Enter crew name">
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                <div class="form-group">
                    <label>Primary Section</label>
                    <select id="newCrewSection">
                        <option value="PRODUCTION">Production</option>
                        <option value="SERVICE">Service</option>
                        <option value="BEVCEL_FRIES">Bevcel & Fries</option>
                        <option value="DRIVE THRU">Drive Thru</option>
                        <option value="CUSTOMER_AREA">Customer Area</option>
                        <option value="MDS">MDS/3PO</option>
                        <option value="MARKETING">Marketing</option>
                        <option value="OTHERS">Others</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Position</label>
                    <select id="newCrewPosition">
                        <option value="Crew">Crew</option>
                        <option value="Crew Trainer">Crew Trainer</option>
                        <option value="Gel">Gel</option>
                        <option value="Maintenance">Maintenance</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>Stations Trained (select multiple)</label>
                <div id="stationCheckboxes" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-height:200px;overflow-y:auto;padding:10px;background:#12121f;border-radius:8px;"></div>
            </div>
            
            <div style="display:flex;gap:10px;margin-top:20px;">
                <button class="btn btn-secondary" onclick="closeModal('addCrewModal')" style="flex:1;">Cancel</button>
                <button class="btn btn-primary" onclick="addNewCrew()" style="flex:1;">Add Crew</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Stations Modal -->
    <div class="modal" id="editStationsModal">
        <div class="modal-content" style="max-width:600px;">
            <div class="modal-header">
                <h3>üìã Edit Stations Trained</h3>
                <button class="modal-close" onclick="closeEditStationsModal()">&times;</button>
            </div>
            <div id="editStationsContent"></div>
            <div style="margin-top:20px;">
                <button class="btn btn-primary" onclick="closeEditStationsModal()" style="width:100%;">‚úì Done</button>
            </div>
        </div>
    </div>
    
    <!-- Auto Rest Suggestion Modal -->
    <div class="modal" id="autoRestModal">
        <div class="modal-content" style="max-width:800px;">
            <div class="modal-header">
                <h3>ü§ñ Auto Rest Suggestions</h3>
                <button class="modal-close" onclick="closeModal('autoRestModal')">&times;</button>
            </div>
            <p style="color:#888;margin-bottom:15px;font-size:12px;">
                Based on scheduled duties, here are suggested rest days to prevent 7th day pay violations. 
                Select suggestions to apply, then click "Apply Selected".
            </p>
            
            <!-- Summary -->
            <div id="autoRestSummary" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;"></div>
            
            <!-- Suggestions List -->
            <div id="autoRestSuggestions" style="max-height:400px;overflow-y:auto;"></div>
            
            <div style="display:flex;gap:10px;margin-top:20px;">
                <button class="btn btn-secondary" onclick="closeModal('autoRestModal')" style="flex:1;">Cancel</button>
                <button class="btn btn-info" onclick="selectAllSuggestions()" style="flex:1;">Select All</button>
                <button class="btn btn-primary" onclick="applySelectedRestSuggestions()" style="flex:1;">‚úì Apply Selected</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div class="modal" id="confirmModal">
        <div class="modal-content" style="max-width:400px;text-align:center;">
            <div style="font-size:48px;margin-bottom:15px;">‚ö†Ô∏è</div>
            <h3 id="confirmTitle" style="margin-bottom:10px;">Confirm Delete</h3>
            <p id="confirmMessage" style="color:#888;margin-bottom:20px;">Are you sure?</p>
            <div style="display:flex;gap:10px;">
                <button class="btn btn-secondary" onclick="closeConfirmModal(false)" style="flex:1;">Cancel</button>
                <button class="btn btn-danger" onclick="closeConfirmModal(true)" style="flex:1;background:#ef4444;">Delete</button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content" style="max-width:400px;">
            <div class="modal-header">
                <h3>üîê Change Password</h3>
                <button class="modal-close" onclick="closeModal('changePasswordModal')">&times;</button>
            </div>
            
            <div id="passwordError" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#ef4444;padding:12px;border-radius:8px;font-size:13px;margin-bottom:15px;display:none;"></div>
            <div id="passwordSuccess" style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);color:#10b981;padding:12px;border-radius:8px;font-size:13px;margin-bottom:15px;display:none;"></div>
            
            <div class="form-group">
                <label>Current Password</label>
                <input type="password" id="currentPassword" placeholder="Enter current password">
            </div>
            
            <div class="form-group">
                <label>New Password</label>
                <input type="password" id="newPassword" placeholder="Enter new password">
            </div>
            
            <div class="form-group">
                <label>Confirm New Password</label>
                <input type="password" id="confirmPassword" placeholder="Confirm new password">
            </div>
            
            <div style="display:flex;gap:10px;margin-top:20px;">
                <button class="btn btn-secondary" onclick="closeModal('changePasswordModal')" style="flex:1;">Cancel</button>
                <button class="btn btn-primary" onclick="changePassword()" style="flex:1;">Change Password</button>
            </div>
        </div>
    </div>

    </div><!-- End of app-container -->

    <script>
    // ==================== CUSTOM CONFIRM MODAL ====================
    let confirmCallback = null;
    
    function showConfirm(title, message, callback) {
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = message;
        confirmCallback = callback;
        document.getElementById('confirmModal').classList.add('show');
    }
    window.showConfirm = showConfirm;
    
    function closeConfirmModal(result) {
        document.getElementById('confirmModal').classList.remove('show');
        if(confirmCallback) {
            confirmCallback(result);
            confirmCallback = null;
        }
    }
    window.closeConfirmModal = closeConfirmModal;
    
    // ==================== AREAS & STATIONS DATA ====================
    const AREAS = {
        production: { name: 'Production', icon: 'üî¥', color: '#ef4444' },
        service: { name: 'Service Areas', icon: 'üîµ', color: '#3b82f6' },
        bevcel_fries: { name: 'Bevcel & Fries', icon: 'üü†', color: '#f97316' },
        drivethru: { name: 'Drive Thru Area', icon: 'üü¢', color: '#10b981' },
        customer_area: { name: 'Customer Area', icon: 'ü©µ', color: '#06b6d4' },
        mds: { name: 'MDS/3PO Area', icon: 'üü£', color: '#a855f7' },
        marketing: { name: 'Marketing', icon: 'üü°', color: '#fbbf24' },
        others: { name: 'Others', icon: '‚ö™', color: '#6b7280' }
    };
    
    // Rest day data storage - { 'YYYY-MM-DD': { crewId: true, ... }, ... }
    let restData = {};

    // GC Ranges per area - these are the UPPER LIMITS of each range
    // Range 1: 0 to gcRanges[0], Range 2: gcRanges[0]+1 to gcRanges[1], etc.
    let gcRanges = {
        production: [20, 40, 60, 80, 100, 120, 150],
        service: [20, 40, 60, 80, 100, 120, 150],
        bevcel_fries: [20, 40, 60, 80, 100, 120, 150],
        drivethru: [20, 40, 60, 80, 100, 120, 150],
        customer_area: [20, 40, 60, 80, 100, 120, 150],
        mds: [20, 40, 60, 80, 100, 120, 150],
        marketing: [20, 40, 60, 80, 100, 120, 150],
        others: [20, 40, 60, 80, 100, 120, 150]
    };

    // Graveyard shift positioning (10PM - 6AM)
    // Simplified stations with fixed crew count (not GC-based since very low traffic)
    let graveyardStations = [
        { id: 'initiator1', name: 'Initiator', crew: 1 },
        { id: 'batch_grill', name: 'Batch Grill', crew: 1 },
        { id: 'assembler', name: 'Assembler', crew: 1 },
        { id: 'prepping', name: 'Prepping', crew: 1 },
        { id: 'chicken_person', name: 'Chicken Person', crew: 1 },
        { id: 'bevcel', name: 'Bevcel', crew: 1 },
        { id: 'fries', name: 'Fries', crew: 1 },
        { id: 'fc1', name: 'FC 1', crew: 1 },
        { id: 'fc2', name: 'FC 2', crew: 1 },
        { id: 'expediter1', name: 'Expediter', crew: 1 },
        { id: 'presenter', name: 'Presenter', crew: 1 },
        { id: 'lobby', name: 'Lobby', crew: 1 },
        { id: 'dtc', name: 'DTC', crew: 1 },
        { id: 'dt_ot', name: 'DT OT', crew: 1 },
        { id: 'dt_presenter', name: 'DT Presenter', crew: 1 },
        { id: 'mds_cashier', name: 'MDS Cashier', crew: 1 },
        { id: 'mds_rider', name: 'MDS Rider', crew: 1 },
        { id: 'gel', name: 'GEL', crew: 0 },
        { id: 'maintenance', name: 'Maintenance', crew: 1 },
    ];

    // Graveyard hours (10PM = 22, 11PM = 23, 12AM = 0, 1AM = 1, ... 5AM = 5)
    const GRAVEYARD_HOURS = [22, 23, 0, 1, 2, 3, 4, 5];

    // Initial stations organized by area
    let stationsData = {
        production: [
            { id: 'initiator1', name: 'Initiator 1' },
            { id: 'initiator2', name: 'Initiator 2' },
            { id: 'batch_grill', name: 'Batch Grill' },
            { id: 'assembler', name: 'Assembler' },
            { id: 'prepping', name: 'Prepping' },
            { id: 'fried_products', name: 'Fried Products' },
            { id: 'chicken_person', name: 'Chicken Person' },
            { id: 'hotcake_eggs', name: 'Hotcake/Eggs' },
        ],
        service: [
            { id: 'fc1', name: 'FC 1' },
            { id: 'fc2', name: 'FC 2' },
            { id: 'fc3', name: 'FC 3' },
            { id: 'presenter', name: 'Presenter' },
            { id: 'expediter1', name: 'Expediter 1' },
            { id: 'expediter2', name: 'Expediter 2' },
        ],
        bevcel_fries: [
            { id: 'fries', name: 'Fries' },
            { id: 'bevcel', name: 'Bevcel' },
        ],
        drivethru: [
            { id: 'dtc', name: 'DTC (Cashier)' },
            { id: 'dt_ot', name: 'DT OT (Order Taker)' },
            { id: 'dt_presenter', name: 'DT Presenter' },
            { id: 'dt_assembler', name: 'DT Assembler' },
        ],
        customer_area: [
            { id: 'lobby', name: 'Lobby' },
        ],
        mds: [
            { id: 'mds_cashier', name: 'MDS Cashier' },
            { id: 'mds_rider', name: 'MDS Rider' },
        ],
        marketing: [
            { id: 'gel', name: 'GEL' },
            { id: 'bp_host', name: 'BP Host' },
            { id: 'bp_assist', name: 'BP Assist' },
            { id: 'bp_character', name: 'BP Character' },
        ],
        others: [
            { id: 'maintenance', name: 'Maintenance' },
            { id: 'pullouts', name: 'Pull-outs' },
            { id: 'boothselling', name: 'Boothselling' },
            { id: 'training', name: 'Training' },
        ]
    };

    // NPG Data - crew needed per station per GC range
    // GC ranges: 0-20, 21-40, 41-60, 61-80, 81-100, 101-120, 121-150, 151+
    let npgData = {};
    
    function initializeNPG() {
        Object.keys(stationsData).forEach(area => {
            stationsData[area].forEach(station => {
                if (!npgData[station.id]) {
                    // Default values based on station type
                    if (['initiator1','initiator2','batch_grill','assembler'].includes(station.id)) {
                        npgData[station.id] = [1, 1, 1, 2, 2, 2, 3, 3];
                    } else if (['fc1','fc2','fc3','dtc','dt_ot'].includes(station.id)) {
                        npgData[station.id] = [1, 1, 1, 2, 2, 2, 2, 3];
                    } else if (['fries','bevcel'].includes(station.id)) {
                        npgData[station.id] = [1, 1, 1, 2, 2, 2, 2, 3];
                    } else if (['chicken_person','fried_products'].includes(station.id)) {
                        npgData[station.id] = [0, 1, 1, 1, 2, 2, 2, 2];
                    } else if (['gel','bp_host','bp_assist','bp_character'].includes(station.id)) {
                        npgData[station.id] = [0, 0, 0, 0, 1, 1, 1, 1];
                    } else if (['hotcake_eggs'].includes(station.id)) {
                        npgData[station.id] = [0, 0, 1, 1, 1, 1, 1, 2];
                    } else if (['lobby'].includes(station.id)) {
                        npgData[station.id] = [0, 1, 1, 1, 2, 2, 2, 2];
                    } else {
                        npgData[station.id] = [0, 1, 1, 1, 1, 2, 2, 2];
                    }
                }
            });
        });
    }

    // Crew data
    let crewData = [
        // PRODUCTION
        { id: 10, name: 'JUNJIE', section: 'PRODUCTION', position: 'Crew Trainer', stations: ['initiator1','initiator2','assembler','prepping','batch_grill','chicken_person'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 11, name: 'DAN CHRISTIAN', section: 'PRODUCTION', position: 'Crew', stations: ['initiator1','initiator2','assembler','prepping','batch_grill','chicken_person'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 12, name: 'ROMNICK', section: 'PRODUCTION', position: 'Crew', stations: ['prepping','batch_grill','fried_products','chicken_person'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 13, name: 'SONNY', section: 'PRODUCTION', position: 'Crew Trainer', stations: ['initiator1','initiator2','assembler','batch_grill','chicken_person'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 14, name: 'CLEMENT', section: 'PRODUCTION', position: 'Crew', stations: ['initiator1','assembler','prepping','batch_grill'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 15, name: 'VINCENT', section: 'PRODUCTION', position: 'Crew', stations: ['initiator1','initiator2','assembler','batch_grill','fries','chicken_person'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 16, name: 'EDGIL', section: 'PRODUCTION', position: 'Crew', stations: ['initiator1','assembler','prepping','batch_grill','chicken_person'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'',sun:''} },
        { id: 17, name: 'REBECCO', section: 'PRODUCTION', position: 'Crew', stations: ['initiator1','initiator2','assembler','batch_grill'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 18, name: 'MELVIN', section: 'PRODUCTION', position: 'Crew', stations: ['initiator1','assembler','batch_grill','fries','bevcel','chicken_person'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 19, name: 'GEORGE', section: 'PRODUCTION', position: 'Crew', stations: ['initiator1','initiator2','assembler','batch_grill','chicken_person'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        
        // SERVICE
        { id: 30, name: 'RIZA', section: 'SERVICE', position: 'Crew Trainer', stations: ['fc1','fc2','fc3','presenter','expediter1','expediter2'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'',sun:''} },
        { id: 31, name: 'LOREVIER', section: 'SERVICE', position: 'Crew', stations: ['fc1','fc2','presenter','expediter1'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 32, name: 'YURIKO', section: 'SERVICE', position: 'Crew', stations: ['fc1','fc2','fc3','presenter','expediter1'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 33, name: 'APRIL', section: 'SERVICE', position: 'Crew Trainer', stations: ['fc1','fc2','presenter','expediter1','expediter2'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 34, name: 'JOHANNA', section: 'SERVICE', position: 'Crew', stations: ['fc1','fc2','fc3','presenter'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 35, name: 'CHARLYN', section: 'SERVICE', position: 'Crew', stations: ['fc1','presenter','expediter1','expediter2'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 36, name: 'JOHNMAR', section: 'SERVICE', position: 'Crew', stations: ['fc1','fc2','fc3','presenter'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        
        // DRIVE THRU
        { id: 50, name: 'CLARA', section: 'DRIVE THRU', position: 'Crew Trainer', stations: ['dtc','dt_ot','dt_presenter','fries'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 51, name: 'ALTHEA', section: 'DRIVE THRU', position: 'Crew', stations: ['dtc','dt_ot','dt_presenter'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 52, name: 'JENESEL', section: 'DRIVE THRU', position: 'Crew', stations: ['dtc','dt_ot','dt_assembler'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 53, name: 'BLESSY', section: 'DRIVE THRU', position: 'Crew', stations: ['dtc','dt_presenter','bevcel'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 54, name: 'CRISTINE', section: 'DRIVE THRU', position: 'Crew', stations: ['dt_ot','dt_presenter','dt_assembler'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        
        // CUSTOMER AREA
        { id: 55, name: 'LOREVIER', section: 'CUSTOMER_AREA', position: 'Crew', stations: ['lobby'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 56, name: 'JOHANNA', section: 'CUSTOMER_AREA', position: 'Crew', stations: ['lobby'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        
        // BEVCEL & FRIES
        { id: 60, name: 'MARGIE', section: 'BEVCEL_FRIES', position: 'Crew', stations: ['fries','bevcel'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 61, name: 'RINA', section: 'BEVCEL_FRIES', position: 'Crew', stations: ['fries','bevcel','fc1'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 62, name: 'MYKA', section: 'BEVCEL_FRIES', stations: ['fries','bevcel'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 63, name: 'JENNY', section: 'BEVCEL_FRIES', stations: ['fries','bevcel','presenter'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        
        // MDS
        { id: 70, name: 'JEAN', section: 'MDS', stations: ['mds_cashier','mds_rider','fc1'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 71, name: 'KIM', section: 'MDS', stations: ['mds_cashier','mds_rider'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        
        // OTHERS
        { id: 80, name: 'CARLOS', section: 'OTHERS', stations: ['maintenance','lobby','pullouts'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
        { id: 81, name: 'ARJIE', section: 'OTHERS', stations: ['maintenance','training','lobby'], availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'} },
    ];

    let scheduleData = {};
    let gcForecast = {};
    let currentDate = new Date(2025, 7, 1);

    // ==================== INITIALIZATION ====================
    const DATA_VERSION = '2.2'; // Added shift preference, overtime tracking, skill gap, auto-rest, 10-hr gap

    function init() {
        // Set to current date
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        
        const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        document.getElementById('monthSelect').innerHTML = months.map((m,i) => `<option value="${i}" ${i===currentMonth?'selected':''}>${m}</option>`).join('');
        document.getElementById('yearSelect').innerHTML = [2024,2025,2026,2027,2028].map(y => `<option value="${y}" ${y===currentYear?'selected':''}>${y}</option>`).join('');
        
        // Set date picker to current date
        document.getElementById('dateSelect').value = now.toISOString().split('T')[0];
        currentDate = now;
        
        // Add event listeners
        document.getElementById('dateSelect').addEventListener('change', e => { currentDate = new Date(e.target.value); renderAll(); });
        document.getElementById('monthSelect').addEventListener('change', () => renderAll());
        document.getElementById('yearSelect').addEventListener('change', () => renderAll());
        
        // Load saved data from Firestore
        loadFromFirestore();
    }

    // ==================== FIRESTORE FUNCTIONS ====================
    
    let firestoreLoaded = false;
    
    async function loadFromFirestore() {
        try {
            showToast('üì° Loading data from cloud...', 'info');
            
            // Load settings
            const settingsDoc = await db.collection('settings').doc('main').get();
            if(settingsDoc.exists) {
                const data = settingsDoc.data();
                if(data.stationsData) stationsData = data.stationsData;
                if(data.npgData) npgData = data.npgData;
                if(data.gcRanges) gcRanges = data.gcRanges;
                if(data.graveyardStations) graveyardStations = data.graveyardStations;
            }
            
            // Load crew data
            const crewDoc = await db.collection('settings').doc('crew').get();
            if(crewDoc.exists && crewDoc.data().crewData) {
                crewData = crewDoc.data().crewData;
            }
            
            // Load rest data
            const restDoc = await db.collection('settings').doc('rest').get();
            if(restDoc.exists && restDoc.data().restData) {
                restData = restDoc.data().restData;
            }
            
            // Load schedules
            const schedulesSnap = await db.collection('schedules').get();
            schedulesSnap.forEach(doc => {
                scheduleData[doc.id] = doc.data().schedule || {};
                gcForecast[doc.id] = doc.data().gcForecast || {};
                if(doc.data().locked) {
                    lockedSchedules[doc.id] = doc.data().locked;
                }
            });
            
            // Load users
            const usersDoc = await db.collection('settings').doc('users').get();
            if(usersDoc.exists && usersDoc.data().users) {
                localStorage.setItem('crewSchedulerUsers', JSON.stringify(usersDoc.data().users));
            }
            
            firestoreLoaded = true;
            initializeNPG();
            buildGCInputGrid();
            renderAll();
            
            showToast('‚úÖ Data loaded from cloud!', 'success');
            
            // Set up real-time listeners
            setupRealtimeListeners();
            
        } catch(error) {
            console.error('Firestore load error:', error);
            showToast('‚ö†Ô∏è Cloud error. Using local data.', 'error');
            
            // Fallback to localStorage
            loadSavedDataLocal();
            initializeNPG();
            buildGCInputGrid();
            renderAll();
        }
    }
    
    function setupRealtimeListeners() {
        // Listen for crew data changes
        db.collection('settings').doc('crew').onSnapshot(doc => {
            if(doc.exists && doc.data().crewData && firestoreLoaded) {
                crewData = doc.data().crewData;
                renderCrew();
                renderDashboard();
            }
        });
        
        // Listen for rest data changes
        db.collection('settings').doc('rest').onSnapshot(doc => {
            if(doc.exists && doc.data().restData && firestoreLoaded) {
                restData = doc.data().restData;
                renderRest();
            }
        });
    }
    
    async function saveToFirestore(collection, docId, data) {
        try {
            await db.collection(collection).doc(docId).set(data, { merge: true });
            return true;
        } catch(error) {
            console.error('Firestore save error:', error);
            showToast('‚ö†Ô∏è Cloud save failed. Saved locally.', 'error');
            return false;
        }
    }
    
    // Save settings (NPG, stations, GC ranges, graveyard)
    async function saveSettingsToFirestore() {
        await saveToFirestore('settings', 'main', {
            stationsData: stationsData,
            npgData: npgData,
            gcRanges: gcRanges,
            graveyardStations: graveyardStations,
            updatedAt: new Date().toISOString()
        });
    }
    
    // Save crew data
    async function saveCrewToFirestore() {
        await saveToFirestore('settings', 'crew', {
            crewData: crewData,
            updatedAt: new Date().toISOString()
        });
    }
    
    // Save rest data
    async function saveRestToFirestore() {
        await saveToFirestore('settings', 'rest', {
            restData: restData,
            updatedAt: new Date().toISOString()
        });
    }
    
    // Save schedule for a specific date
    async function saveScheduleToFirestore(dateKey) {
        await saveToFirestore('schedules', dateKey, {
            schedule: scheduleData[dateKey] || {},
            gcForecast: gcForecast[dateKey] || {},
            locked: lockedSchedules[dateKey] || null,
            updatedAt: new Date().toISOString()
        });
    }
    
    // Save users
    async function saveUsersToFirestore() {
        const users = JSON.parse(localStorage.getItem('crewSchedulerUsers') || '{}');
        await saveToFirestore('settings', 'users', {
            users: users,
            updatedAt: new Date().toISOString()
        });
    }

    // Fallback local storage functions
    function loadSavedDataLocal() {
        const savedStations = localStorage.getItem('stationsData');
        const savedNPG = localStorage.getItem('npgData');
        const savedCrew = localStorage.getItem('crewData');
        const savedGCRanges = localStorage.getItem('gcRanges');
        const savedGraveyard = localStorage.getItem('graveyardStations');
        const savedRest = localStorage.getItem('restData');
        
        if (savedStations) {
            const parsed = JSON.parse(savedStations);
            Object.keys(stationsData).forEach(area => {
                if (!parsed[area] || parsed[area].length === 0) {
                    parsed[area] = stationsData[area];
                }
            });
            stationsData = parsed;
        }
        if (savedNPG) npgData = JSON.parse(savedNPG);
        if (savedCrew) crewData = JSON.parse(savedCrew);
        if (savedGCRanges) {
            const parsed = JSON.parse(savedGCRanges);
            if (!parsed.bevcel_fries) {
                parsed.bevcel_fries = [20, 40, 60, 80, 100, 120, 150];
            }
            gcRanges = parsed;
        }
        if (savedGraveyard) graveyardStations = JSON.parse(savedGraveyard);
        if (savedRest) restData = JSON.parse(savedRest);
    }

    function saveToLocalStorage() {
        // Save to localStorage as backup
        localStorage.setItem('stationsData', JSON.stringify(stationsData));
        localStorage.setItem('npgData', JSON.stringify(npgData));
        localStorage.setItem('crewData', JSON.stringify(crewData));
        localStorage.setItem('gcRanges', JSON.stringify(gcRanges));
        localStorage.setItem('graveyardStations', JSON.stringify(graveyardStations));
        localStorage.setItem('restData', JSON.stringify(restData));
        
        // Also save to Firestore
        saveSettingsToFirestore();
        saveCrewToFirestore();
        saveRestToFirestore();
    }

    function buildGCInputGrid() {
        let html = '';
        // 24-hour operation: 12AM (0) to 11PM (23)
        for(let h = 0; h <= 23; h++) {
            const label = h === 0 ? '12AM' : (h < 12 ? `${h}AM` : (h === 12 ? '12PM' : `${h-12}PM`));
            const defaultGC = {
                0:5, 1:3, 2:3, 3:3, 4:5, 5:10,  // Early morning
                6:15, 7:25, 8:35, 9:40, 10:50, 11:70,  // Morning
                12:100, 13:80, 14:50, 15:40, 16:45, 17:60,  // Afternoon
                18:90, 19:100, 20:70, 21:50, 22:30, 23:15  // Evening
            }[h] || 10;
            
            // Highlight breakfast hours (4:30AM-10:30AM = hours 4,5,6,7,8,9,10)
            const isBreakfast = h >= 4 && h <= 10;
            const borderColor = isBreakfast ? '#fbbf24' : '#333';
            const labelColor = isBreakfast ? '#fbbf24' : '#888';
            
            html += `<div class="gc-item" style="border-color:${borderColor};">
                <label style="color:${labelColor};">${label}${isBreakfast ? ' üç≥' : ''}</label>
                <input type="number" id="gc-${h}" value="${defaultGC}" min="0" max="500">
            </div>`;
        }
        document.getElementById('gcInputGrid').innerHTML = html;
    }

    // ==================== NPG FUNCTIONS ====================
    function renderNPG() {
        let html = '';
        
        // Graveyard Positioning Section
        html += `
            <div class="npg-area area-graveyard" id="area-graveyard" style="margin-bottom:25px;">
                <div class="npg-area-header" onclick="toggleArea('graveyard')" style="background:linear-gradient(135deg,rgba(30,41,59,0.8),rgba(15,23,42,0.8));border-left:4px solid #475569;">
                    <h4>
                        <span class="area-icon" style="background:rgba(71,85,105,0.3);color:#94a3b8;">üåô</span>
                        Graveyard Positioning (10PM - 6AM)
                        <span class="station-count">${graveyardStations.length} stations</span>
                    </h4>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="npg-area-body">
                    <div style="margin-bottom:15px;padding:12px;background:rgba(0,0,0,0.3);border-radius:8px;">
                        <p style="font-size:12px;color:#94a3b8;margin-bottom:10px;">üåô <strong>Graveyard shift</strong> uses fixed crew counts (not GC-based) since traffic is minimal during 10PM-6AM.</p>
                        <p style="font-size:11px;color:#666;">Set the number of crew needed for each station during graveyard hours.</p>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
                        ${graveyardStations.map((station, idx) => `
                            <div style="background:#12121f;padding:12px;border-radius:8px;border:1px solid #333;display:flex;justify-content:space-between;align-items:center;">
                                <span style="font-size:12px;color:#fff;">${station.name}</span>
                                <input type="number" min="0" max="5" value="${station.crew}" 
                                    style="width:50px;padding:6px;background:#1a1a2e;border:1px solid #444;border-radius:4px;color:#94a3b8;text-align:center;font-size:14px;font-weight:600;"
                                    data-graveyard-idx="${idx}" onchange="updateGraveyardCrew(this)">
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top:15px;padding:10px;background:rgba(71,85,105,0.2);border-radius:8px;border:1px solid #475569;">
                        <p style="font-size:11px;color:#94a3b8;">
                            <strong>Total Graveyard Crew:</strong> <span id="graveyardTotal">${graveyardStations.reduce((sum, s) => sum + s.crew, 0)}</span> per hour
                        </p>
                    </div>
                </div>
            </div>
        `;
        
        // Regular Areas
        Object.entries(AREAS).forEach(([areaId, area]) => {
            const stations = stationsData[areaId] || [];
            const ranges = gcRanges[areaId] || [20, 40, 60, 80, 100, 120, 150];
            
            // Generate range labels based on upper limits
            const rangeLabels = [];
            for(let i = 0; i < ranges.length; i++) {
                const start = (i === 0) ? 0 : ranges[i-1] + 1;
                const end = ranges[i];
                rangeLabels.push(`${start}-${end}`);
            }
            rangeLabels.push(`${ranges[ranges.length-1] + 1}+`);
            
            html += `
                <div class="npg-area area-${areaId}" id="area-${areaId}">
                    <div class="npg-area-header" onclick="toggleArea('${areaId}')">
                        <h4>
                            <span class="area-icon" style="background:${area.color}20;color:${area.color};">${area.icon}</span>
                            ${area.name}
                            <span class="station-count">${stations.length} stations</span>
                        </h4>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="npg-area-body">
                        <!-- Editable GC Ranges -->
                        <div style="margin-bottom:15px;padding:12px;background:rgba(0,0,0,0.3);border-radius:8px;">
                            <label style="font-size:11px;color:#888;display:block;margin-bottom:8px;">üìä Edit the UPPER LIMIT of each GC range</label>
                            <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
                                <span style="font-size:12px;color:#888;padding:0 5px;">0 -</span>
                                ${ranges.map((val, i) => `
                                    <input type="number" value="${val}" min="1" max="500" 
                                        style="width:50px;padding:6px;background:#12121f;border:1px solid #444;border-radius:4px;color:#fbbf24;text-align:center;font-size:12px;font-weight:600;"
                                        data-area="${areaId}" data-range-idx="${i}" onchange="updateGCRange(this)">
                                    <span style="font-size:12px;color:#888;padding:0 5px;">${i < ranges.length - 1 ? '|' : '| then'}</span>
                                `).join('')}
                                <span style="font-size:12px;color:#10b981;font-weight:600;">${ranges[ranges.length-1] + 1}+</span>
                            </div>
                            <div style="margin-top:8px;font-size:10px;color:#666;">
                                Ranges: ${rangeLabels.join(' | ')}
                            </div>
                        </div>
                        
                        <table class="npg-table">
                            <thead>
                                <tr>
                                    <th style="text-align:left;min-width:150px;">Station</th>
                                    ${rangeLabels.map(label => `<th class="gc-range">${label}</th>`).join('')}
                                    <th style="width:40px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${stations.map(station => `
                                    <tr>
                                        <td class="station-name">${station.name}</td>
                                        ${(npgData[station.id] || [0,0,0,0,0,0,0,0]).map((val, i) => 
                                            `<td><input type="number" min="0" max="10" value="${val}" data-station="${station.id}" data-range="${i}" onchange="updateNPG(this)"></td>`
                                        ).join('')}
                                        <td><button class="delete-btn" onclick="deleteStation('${areaId}','${station.id}')" title="Delete">üóëÔ∏è</button></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        });
        
        document.getElementById('npgAreas').innerHTML = html;
        
        // Count total stations
        let totalStations = 0;
        Object.values(stationsData).forEach(stations => totalStations += stations.length);
        const statTotalStationsEl = document.getElementById('statTotalStations');
        if(statTotalStationsEl) statTotalStationsEl.textContent = totalStations;
    }

    function updateGraveyardCrew(input) {
        const idx = parseInt(input.dataset.graveyardIdx);
        graveyardStations[idx].crew = parseInt(input.value) || 0;
        
        // Update total display
        const total = graveyardStations.reduce((sum, s) => sum + s.crew, 0);
        const totalEl = document.getElementById('graveyardTotal');
        if(totalEl) totalEl.textContent = total;
    }
    window.updateGraveyardCrew = updateGraveyardCrew;

    function updateGCRange(input) {
        const areaId = input.dataset.area;
        const rangeIdx = parseInt(input.dataset.rangeIdx);
        let value = parseInt(input.value) || 1;
        
        if (!gcRanges[areaId]) gcRanges[areaId] = [20, 40, 60, 80, 100, 120, 150];
        
        // Ensure minimum value of 1
        if(value < 1) value = 1;
        
        // Ensure this value is greater than previous range
        if(rangeIdx > 0 && value <= gcRanges[areaId][rangeIdx - 1]) {
            value = gcRanges[areaId][rangeIdx - 1] + 1;
        }
        
        // Update the value
        gcRanges[areaId][rangeIdx] = value;
        
        // Ensure subsequent ranges are still valid (each must be greater than previous)
        for(let i = rangeIdx + 1; i < gcRanges[areaId].length; i++) {
            if(gcRanges[areaId][i] <= gcRanges[areaId][i-1]) {
                gcRanges[areaId][i] = gcRanges[areaId][i-1] + 1;
            }
        }
        
        // Re-render to update labels
        renderNPG();
        
        // Re-expand the area that was being edited
        document.getElementById(`area-${areaId}`).classList.add('expanded');
    }
    window.updateGCRange = updateGCRange;

    function toggleArea(areaId) {
        document.getElementById(`area-${areaId}`).classList.toggle('expanded');
    }
    window.toggleArea = toggleArea;

    function updateNPG(input) {
        const station = input.dataset.station;
        const range = parseInt(input.dataset.range);
        if (!npgData[station]) npgData[station] = [0,0,0,0,0,0,0,0];
        npgData[station][range] = parseInt(input.value) || 0;
    }
    window.updateNPG = updateNPG;

    function showToast(message, type = 'success') {
        // Remove existing toast
        const existingToast = document.getElementById('toast-notification');
        if(existingToast) existingToast.remove();
        
        // Create toast element
        const toast = document.createElement('div');
        toast.id = 'toast-notification';
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            font-size: 14px;
            z-index: 10000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
            max-width: 400px;
            line-height: 1.5;
        `;
        
        if(type === 'success') {
            toast.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        } else if(type === 'error') {
            toast.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
        } else {
            toast.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
        }
        
        toast.innerHTML = message;
        document.body.appendChild(toast);
        
        // Auto remove after 4 seconds
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }
    
    // Add toast animation styles
    const toastStyles = document.createElement('style');
    toastStyles.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(toastStyles);

    function saveNPG() {
        try {
            saveToLocalStorage();
            saveSettingsToFirestore();
            
            // Count totals for feedback
            let totalStations = 0;
            Object.values(stationsData).forEach(stations => totalStations += stations.length);
            
            // Show success toast
            showToast(`‚úÖ NPG Settings Saved!<br><br>
                üìä <b>${totalStations}</b> stations configured<br>
                üìã <b>${Object.keys(npgData).length}</b> NPG entries<br>
                üåô <b>${graveyardStations.length}</b> graveyard positions<br>
                ‚òÅÔ∏è Synced to cloud`, 'success');
                
        } catch(e) {
            showToast('‚ùå Error saving NPG: ' + e.message, 'error');
            console.error('Save NPG error:', e);
        }
    }
    
    // Make NPG functions globally accessible
    window.saveNPG = saveNPG;
    window.showToast = showToast;

    function openAddStationModal() {
        document.getElementById('newStationName').value = '';
        document.getElementById('addStationModal').classList.add('show');
    }
    window.openAddStationModal = openAddStationModal;

    function addNewStation() {
        const name = document.getElementById('newStationName').value.trim();
        const area = document.getElementById('newStationArea').value;
        
        if (!name) { alert('Please enter a station name'); return; }
        
        const id = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
        
        // Check if already exists
        if (stationsData[area].find(s => s.id === id)) {
            alert('A station with this name already exists in this area');
            return;
        }
        
        stationsData[area].push({ id, name });
        npgData[id] = [0, 0, 1, 1, 1, 1, 2, 2]; // Default values
        
        saveToLocalStorage();
        closeModal('addStationModal');
        renderNPG();
        alert(`‚úÖ Station "${name}" added to ${AREAS[area].name}!`);
    }
    window.addNewStation = addNewStation;

    function deleteStation(areaId, stationId) {
        if (!confirm('Delete this station? This will also remove it from all crew training records.')) return;
        
        stationsData[areaId] = stationsData[areaId].filter(s => s.id !== stationId);
        delete npgData[stationId];
        
        // Remove from crew stations
        crewData.forEach(crew => {
            crew.stations = crew.stations.filter(s => s !== stationId);
        });
        
        saveToLocalStorage();
        renderNPG();
    }
    window.deleteStation = deleteStation;

    function getGCRangeIndex(gc, areaId) {
        const ranges = gcRanges[areaId] || [20, 40, 60, 80, 100, 120, 150];
        // ranges are upper limits: [20, 40, 60, 80, 100, 120, 150]
        // means: 0-20 (idx 0), 21-40 (idx 1), 41-60 (idx 2), etc.
        for(let i = 0; i < ranges.length; i++) {
            if(gc <= ranges[i]) return i;
        }
        // If gc > last range, return last index + 1
        return ranges.length;
    }

    function getRequiredCrewForHour(gc) {
        const required = {};
        Object.keys(stationsData).forEach(areaId => {
            const rangeIdx = getGCRangeIndex(gc, areaId);
            stationsData[areaId].forEach(station => {
                required[station.id] = (npgData[station.id] || [0,0,0,0,0,0,0,0])[rangeIdx];
            });
        });
        return required;
    }

    function getAllStations() {
        const all = [];
        Object.keys(stationsData).forEach(area => {
            stationsData[area].forEach(station => {
                all.push({ ...station, area });
            });
        });
        return all;
    }

    function getStationName(stationId) {
        const allStations = getAllStations();
        const station = allStations.find(s => s.id === stationId);
        return station ? station.name : stationId;
    }

    // ==================== AUTO-FILL ====================
    function openAutoFillModal() {
        document.getElementById('autoFillDate').value = currentDate.toISOString().split('T')[0];
        const modal = document.getElementById('autoFillModal');
        modal.classList.add('show');
    }
    window.openAutoFillModal = openAutoFillModal;

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if(modal) {
            modal.classList.remove('show');
            modal.style.display = ''; // Reset inline style
        }
    }
    window.closeModal = closeModal;
    
    function resetDailySchedule() {
        const dateKey = currentDate.toISOString().split('T')[0];
        
        // Check if schedule is locked
        if(lockedSchedules[dateKey]) {
            alert('‚ö†Ô∏è This schedule is locked. Click "Edit" to unlock it first.');
            return;
        }
        
        const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        const dateDisplay = months[currentDate.getMonth()] + ' ' + currentDate.getDate() + ', ' + currentDate.getFullYear();
        
        // Clear schedule data for this date
        scheduleData[dateKey] = {};
        
        // Clear GC forecast for this date
        gcForecast[dateKey] = {};
        
        // Clear sales input
        const grossSalesEl = document.getElementById('grossSales');
        if(grossSalesEl) grossSalesEl.value = '';
        
        const netSalesEl = document.getElementById('netSales');
        if(netSalesEl) netSalesEl.value = '';
        
        // Re-render
        renderDaily();
        
        alert('‚úÖ Schedule cleared for ' + dateDisplay);
    }
    
    // Make reset function globally accessible
    window.resetDailySchedule = resetDailySchedule;
    
    // Locked schedules storage
    let lockedSchedules = {};
    
    // Load locked schedules - now done via Firestore in loadFromFirestore()
    function loadLockedSchedules() {
        // Legacy support - load from localStorage if exists
        const saved = localStorage.getItem('lockedSchedules');
        if(saved) {
            lockedSchedules = JSON.parse(saved);
        }
    }
    
    // Save locked schedules - now saves to Firestore
    function saveLockedSchedules() {
        localStorage.setItem('lockedSchedules', JSON.stringify(lockedSchedules));
    }
    
    // Save and lock daily schedule
    function saveDailySchedule() {
        const dateKey = currentDate.toISOString().split('T')[0];
        const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        const dateDisplay = months[currentDate.getMonth()] + ' ' + currentDate.getDate() + ', ' + currentDate.getFullYear();
        
        // Check if there's anything to save
        const daySchedule = scheduleData[dateKey] || {};
        const crewCount = Object.keys(daySchedule).filter(id => {
            const entry = daySchedule[id];
            return entry && Object.keys(entry.hours || {}).length > 0;
        }).length;
        
        if(crewCount === 0) {
            showToast('‚ö†Ô∏è No crew scheduled for this date. Nothing to save.', 'error');
            return;
        }
        
        // Lock the schedule
        lockedSchedules[dateKey] = {
            lockedAt: new Date().toISOString(),
            crewCount: crewCount
        };
        
        // Save to localStorage and Firestore
        saveLockedSchedules();
        saveToLocalStorage();
        saveScheduleToFirestore(dateKey);
        
        // Update UI
        renderDaily();
        
        showToast(`‚úÖ Schedule Saved & Locked!<br><br>
            üìÖ ${dateDisplay}<br>
            üë• ${crewCount} crew members scheduled<br>
            üîí Protected from changes<br>
            ‚òÅÔ∏è Synced to cloud`, 'success');
    }
    
    // Unlock schedule for editing
    function editDailySchedule() {
        const dateKey = currentDate.toISOString().split('T')[0];
        const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        const dateDisplay = months[currentDate.getMonth()] + ' ' + currentDate.getDate() + ', ' + currentDate.getFullYear();
        
        // Unlock the schedule
        delete lockedSchedules[dateKey];
        
        // Save to localStorage and Firestore
        saveLockedSchedules();
        saveScheduleToFirestore(dateKey);
        
        // Update UI
        renderDaily();
        
        showToast('‚úèÔ∏è Schedule unlocked for ' + dateDisplay + '<br><br>You can now make changes.<br>Click "Save" when done to lock it again.', 'info');
    }
    
    // Check if current date's schedule is locked
    function isScheduleLocked(dateKey) {
        return lockedSchedules[dateKey] !== undefined;
    }
    
    // Make functions globally accessible
    window.saveDailySchedule = saveDailySchedule;
    window.editDailySchedule = editDailySchedule;
    
    // Delete a specific crew's schedule for the day
    function deleteCrewSchedule(crewId) {
        const dateKey = currentDate.toISOString().split('T')[0];
        
        // Check if schedule is locked
        if(lockedSchedules[dateKey]) {
            alert('‚ö†Ô∏è This schedule is locked. Click "Edit" to unlock it first.');
            return;
        }
        
        // Get crew name for confirmation
        let crewName = 'This crew';
        const crew = crewData.find(c => c.id == crewId);
        if(crew) {
            crewName = crew.name;
        } else if(scheduleData[dateKey]?.[crewId]?.tempName) {
            crewName = scheduleData[dateKey][crewId].tempName;
        }
        
        // Delete the crew's schedule
        if(scheduleData[dateKey] && scheduleData[dateKey][crewId]) {
            delete scheduleData[dateKey][crewId];
        }
        
        renderDaily();
    }
    
    // Make it globally accessible
    window.deleteCrewSchedule = deleteCrewSchedule;

    function runAutoFill() {
        const dateStr = document.getElementById('autoFillDate').value;
        const targetDate = new Date(dateStr);
        const dayName = ['sun','mon','tue','wed','thu','fri','sat'][targetDate.getDay()];
        const dayNameFull = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][targetDate.getDay()];
        
        // Get min/max duty hours
        const minDutyHours = parseInt(document.getElementById('minDutyHours').value) || 4;
        const maxDutyHours = parseInt(document.getElementById('maxDutyHours').value) || 8;
        
        if(minDutyHours > maxDutyHours) {
            alert('‚ö†Ô∏è Minimum duty hours cannot be greater than maximum duty hours!');
            return;
        }
        
        // Get hourly GC for full 24 hours
        const hourlyGC = {};
        for(let h = 0; h <= 23; h++) {
            hourlyGC[h] = parseInt(document.getElementById(`gc-${h}`).value) || 0;
        }
        
        const month = targetDate.getMonth();
        const year = targetDate.getFullYear();
        
        // Define shift time ranges for preference matching
        const shiftRanges = {
            morning: { start: 5, end: 14 },    // 5AM - 2PM
            mid: { start: 10, end: 19 },       // 10AM - 7PM
            evening: { start: 14, end: 23 },   // 2PM - 11PM
            graveyard: { start: 21, end: 6 }   // 9PM - 6AM (overnight)
        };
        
        // ==================== HELPER FUNCTIONS ====================
        
        // Get previous day's schedule for 10-hour gap check
        function getPreviousDayEndTime(crewId) {
            const prevDate = new Date(targetDate);
            prevDate.setDate(prevDate.getDate() - 1);
            const prevDateStr = prevDate.toISOString().split('T')[0];
            const prevEntry = scheduleData[prevDateStr]?.[crewId];
            if(!prevEntry || !prevEntry.hours) return null;
            
            const hours = Object.keys(prevEntry.hours).map(h => parseInt(h)).sort((a,b) => a-b);
            if(hours.length === 0) return null;
            
            return Math.max(...hours) + 1; // End hour (exclusive)
        }
        
        // Check 10-hour gap rule
        function check10HourGap(crewId, proposedStartHour) {
            const prevEndHour = getPreviousDayEndTime(crewId);
            if(prevEndHour === null) return { valid: true, gap: null };
            
            // Calculate gap: hours from prev end to proposed start
            // If prev ended at 22 (10PM), and proposing 8AM start, gap = 24 - 22 + 8 = 10
            let gap;
            if(proposedStartHour >= prevEndHour) {
                gap = proposedStartHour - prevEndHour;
            } else {
                gap = (24 - prevEndHour) + proposedStartHour;
            }
            
            return { valid: gap >= 10, gap, prevEndHour };
        }
        
        // Calculate duty streak
        function getCrewStreak(crewId) {
            let streak = 0;
            for(let d = targetDate.getDate() - 1; d >= 1; d--) {
                const checkDate = `${year}-${(month+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const entry = scheduleData[checkDate]?.[crewId];
                const hours = entry ? Object.keys(entry.hours||{}).length : 0;
                const isRest = restData[checkDate]?.[crewId] === true;
                if(hours > 0 && !isRest) {
                    streak++;
                } else {
                    break;
                }
            }
            return streak;
        }
        
        // Get weekly hours (past 7 days including today)
        function getWeeklyHours(crewId, includeToday = false) {
            let total = 0;
            for(let d = 1; d <= 6; d++) {
                const checkDate = new Date(targetDate);
                checkDate.setDate(checkDate.getDate() - d);
                const checkDateStr = checkDate.toISOString().split('T')[0];
                const entry = scheduleData[checkDateStr]?.[crewId];
                total += entry ? Object.keys(entry.hours||{}).length : 0;
            }
            return total;
        }
        
        // Get monthly hours and days
        function getMonthlyStats(crewId) {
            let hours = 0, days = 0;
            for(let d = 1; d < targetDate.getDate(); d++) {
                const checkDate = `${year}-${(month+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const entry = scheduleData[checkDate]?.[crewId];
                const h = entry ? Object.keys(entry.hours||{}).length : 0;
                hours += h;
                if(h > 0) days++;
            }
            return { hours, days };
        }
        
        // Check shift preference match
        function getShiftPreferenceScore(shiftPref, hour) {
            if(shiftPref === 'any') return 0;
            
            const range = shiftRanges[shiftPref];
            if(!range) return 0;
            
            // Handle overnight shifts (graveyard)
            if(range.start > range.end) {
                if(hour >= range.start || hour < range.end) return -20; // Preferred
                return 20; // Not preferred
            } else {
                if(hour >= range.start && hour < range.end) return -20; // Preferred
                return 20; // Not preferred
            }
        }
        
        // ==================== SKILL GAP ANALYSIS ====================
        const skillGapWarnings = [];
        const breakfastHours = [4, 5, 6, 7, 8, 9, 10];
        const graveyardHours = [22, 23, 0, 1, 2, 3, 4, 5];
        
        // Check each station for qualified crew
        function analyzeSkillGaps() {
            const allStations = new Set();
            Object.values(stationsData).forEach(stations => {
                stations.forEach(s => allStations.add(s.id));
            });
            
            allStations.forEach(stationId => {
                const qualifiedCrew = crewData.filter(c => 
                    c.status !== 'inactive' && 
                    c.stations?.includes(stationId) &&
                    c.availability?.[dayName] && 
                    c.availability[dayName].toUpperCase() !== 'OFF'
                );
                
                // Get max needed for this station
                let maxNeeded = 0;
                for(let h = 0; h <= 23; h++) {
                    const isGraveyard = graveyardHours.includes(h);
                    if(isGraveyard) {
                        const gStation = graveyardStations.find(s => s.id === stationId);
                        if(gStation) maxNeeded = Math.max(maxNeeded, gStation.crew);
                    } else {
                        const gc = hourlyGC[h] || 0;
                        const rangeIdx = getGCRangeIndex(gc, Object.keys(stationsData).find(a => 
                            stationsData[a].some(s => s.id === stationId)
                        ) || 'production');
                        const needed = npgData[stationId]?.[rangeIdx] || 0;
                        maxNeeded = Math.max(maxNeeded, needed);
                    }
                }
                
                if(maxNeeded > 0 && qualifiedCrew.length < maxNeeded) {
                    skillGapWarnings.push({
                        station: getStationName(stationId),
                        stationId,
                        needed: maxNeeded,
                        available: qualifiedCrew.length,
                        gap: maxNeeded - qualifiedCrew.length
                    });
                }
            });
        }
        
        analyzeSkillGaps();
        
        // ==================== BUILD CREW ELIGIBILITY ====================
        const crewEligibility = crewData.map(crew => {
            const streak = getCrewStreak(crew.id);
            const monthlyStats = getMonthlyStats(crew.id);
            const weeklyHours = getWeeklyHours(crew.id);
            const isInactive = crew.status === 'inactive';
            const isOnRest = restData[dateStr]?.[crew.id] === true;
            const availStr = crew.availability?.[dayName] || '';
            const isAvailableToday = availStr && availStr.toUpperCase() !== 'OFF';
            const wouldHit7thDay = streak >= 6;
            const wouldHit6thDay = streak >= 5;
            const shiftPref = crew.shiftPreference || 'any';
            
            // Check 10-hour gap
            const availability = parseAvailability(availStr);
            let gapCheck = { valid: true, gap: null };
            if(availability) {
                gapCheck = check10HourGap(crew.id, availability.start);
            }
            
            let eligibleStatus = 'available';
            let reason = '';
            let blocked = false;
            
            if(isInactive) {
                eligibleStatus = 'blocked'; reason = 'Inactive'; blocked = true;
            } else if(isOnRest) {
                eligibleStatus = 'blocked'; reason = 'Rest day'; blocked = true;
            } else if(!isAvailableToday) {
                eligibleStatus = 'blocked'; reason = `Off on ${dayNameFull}`; blocked = true;
            } else if(wouldHit7thDay) {
                eligibleStatus = 'blocked'; reason = `7th day violation (${streak} streak)`; blocked = true;
            } else if(!gapCheck.valid) {
                eligibleStatus = 'blocked'; reason = `10-hr gap violation (${gapCheck.gap}hr gap)`; blocked = true;
            } else if(wouldHit6thDay) {
                eligibleStatus = 'warning'; reason = `6th day (${streak} streak)`;
            } else if(weeklyHours >= 48) {
                eligibleStatus = 'warning'; reason = `Weekly OT (${weeklyHours}hrs)`;
            }
            
            return {
                crew, streak, monthlyStats, weeklyHours, isInactive, isOnRest,
                isAvailableToday, wouldHit7thDay, wouldHit6thDay, shiftPref,
                eligibleStatus, reason, blocked, gapCheck,
                availability: parseAvailability(availStr),
                priorityScore: calculatePriorityScore(streak, monthlyStats.hours, monthlyStats.days, 
                    crew.stations?.length || 0, wouldHit6thDay, weeklyHours)
            };
        });
        
        function calculatePriorityScore(streak, monthlyHours, daysWorked, stationCount, wouldHit6thDay, weeklyHours) {
            let score = 0;
            score += streak * 15;
            score += monthlyHours * 0.5;
            score += daysWorked * 3;
            score -= stationCount * 5;
            if(wouldHit6thDay) score += 150;
            if(weeklyHours >= 40) score += 50;
            if(weeklyHours >= 48) score += 100;
            return score;
        }
        
        const eligibleCrew = crewEligibility.filter(e => !e.blocked);
        const blockedCrew = crewEligibility.filter(e => e.blocked);
        const warningCrew = crewEligibility.filter(e => e.eligibleStatus === 'warning');
        
        // ==================== SHIFT DEFINITIONS ====================
        // Define the 3 main shifts with their hour ranges
        const SHIFTS = {
            open: { name: 'Open', start: 5, end: 11, hours: [5, 6, 7, 8, 9, 10] },
            mid: { name: 'Mid', start: 10, end: 17, hours: [10, 11, 12, 13, 14, 15, 16] },
            close: { name: 'Close', start: 17, end: 24, hours: [17, 18, 19, 20, 21, 22, 23] }
        };
        
        // Track crew trainers assigned per shift
        const shiftTrainerCount = { open: 0, mid: 0, close: 0 };
        const TRAINERS_PER_SHIFT = 1; // Minimum trainers per shift
        
        // Get shift for a given hour
        function getShiftForHour(hour) {
            if(hour >= 5 && hour < 11) return 'open';
            if(hour >= 10 && hour < 17) return 'mid';
            if(hour >= 17 && hour <= 23) return 'close';
            return null; // Graveyard hours
        }
        
        // ==================== SCHEDULING ALGORITHM ====================
        scheduleData[dateStr] = {};
        gcForecast[dateStr] = hourlyGC;
        
        const crewAssignments = {};
        const unfilledPositions = [];
        const sixthDayAssignments = [];
        const overtimeAlerts = [];
        const gapViolations = [];
        
        // ==================== PHASE 1: ASSIGN CREW TRAINERS FIRST ====================
        // Ensure each shift has at least one Crew Trainer
        
        const crewTrainers = eligibleCrew.filter(e => e.crew.position === 'Crew Trainer');
        const assignedTrainers = { open: [], mid: [], close: [] };
        
        // Sort trainers by priority (least worked first)
        crewTrainers.sort((a, b) => a.priorityScore - b.priorityScore);
        
        // Assign trainers to each shift
        Object.entries(SHIFTS).forEach(([shiftKey, shiftInfo]) => {
            if(shiftKey === 'graveyard') return; // Skip graveyard for now
            
            // Find available trainers for this shift
            const availableTrainers = crewTrainers.filter(e => {
                if(!e.availability) return false;
                
                // Check if trainer is available during shift hours
                const shiftStart = shiftInfo.start;
                const shiftEnd = shiftInfo.end > 24 ? shiftInfo.end - 24 : shiftInfo.end;
                
                let canWorkShift = false;
                for(const h of shiftInfo.hours) {
                    let isAvailable = false;
                    if(e.availability.end > 24) {
                        isAvailable = (h >= e.availability.start || h < (e.availability.end - 24));
                    } else {
                        isAvailable = (h >= e.availability.start && h < e.availability.end);
                    }
                    if(isAvailable) {
                        canWorkShift = true;
                        break;
                    }
                }
                
                if(!canWorkShift) return false;
                
                // Check 10-hour gap
                const gapCheck = check10HourGap(e.crew.id, shiftInfo.start);
                if(!gapCheck.valid) return false;
                
                // Not already assigned to another shift
                if(crewAssignments[e.crew.id]) return false;
                
                return true;
            });
            
            // Assign up to TRAINERS_PER_SHIFT trainers to this shift
            for(let i = 0; i < Math.min(availableTrainers.length, TRAINERS_PER_SHIFT); i++) {
                const trainer = availableTrainers[i];
                const crewId = trainer.crew.id;
                
                // Find a station this trainer can work
                const trainedStations = trainer.crew.stations || [];
                let assignedStation = trainedStations[0] || 'fc1'; // Default to first trained station
                
                // Initialize assignment
                crewAssignments[crewId] = {
                    station: assignedStation,
                    hours: {},
                    isTrainer: true
                };
                
                // Assign hours for this shift (up to maxDutyHours)
                let hoursAssigned = 0;
                for(const h of shiftInfo.hours) {
                    if(hoursAssigned >= maxDutyHours) break;
                    
                    // Check availability for this hour
                    let isAvailable = false;
                    if(trainer.availability.end > 24) {
                        isAvailable = (h >= trainer.availability.start || h < (trainer.availability.end - 24));
                    } else {
                        isAvailable = (h >= trainer.availability.start && h < trainer.availability.end);
                    }
                    
                    if(isAvailable) {
                        crewAssignments[crewId].hours[h] = true;
                        hoursAssigned++;
                    }
                }
                
                assignedTrainers[shiftKey].push(trainer.crew.name);
                shiftTrainerCount[shiftKey]++;
            }
        });
        
        // ==================== PHASE 2: FILL REMAINING POSITIONS ====================
        for(let h = 0; h <= 23; h++) {
            const isGraveyardHour = graveyardHours.includes(h);
            const isBreakfastHour = breakfastHours.includes(h);
            const currentShift = getShiftForHour(h);
            
            let required = {};
            if(isGraveyardHour) {
                graveyardStations.forEach(station => {
                    if(station.crew > 0) required[station.id] = station.crew;
                });
            } else {
                required = getRequiredCrewForHour(hourlyGC[h]);
            }
            
            Object.entries(required).forEach(([stationId, neededCount]) => {
                if(neededCount <= 0) return;
                if(stationId === 'hotcake_eggs' && !isBreakfastHour) return;
                
                let currentlyAssigned = 0;
                Object.values(crewAssignments).forEach(assignment => {
                    if(assignment.hours[h] && assignment.station === stationId) currentlyAssigned++;
                });
                
                const stillNeeded = neededCount - currentlyAssigned;
                if(stillNeeded <= 0) return;
                
                // Find eligible candidates
                const candidates = eligibleCrew.filter(e => {
                    if(!e.crew.stations?.includes(stationId)) return false;
                    if(!e.availability) return false;
                    
                    let isAvailable = false;
                    if(e.availability.end > 24) {
                        isAvailable = (h >= e.availability.start || h < (e.availability.end - 24));
                    } else {
                        isAvailable = (h >= e.availability.start && h < e.availability.end);
                    }
                    if(!isAvailable) return false;
                    
                    // Check 10-hour gap for first hour assignment
                    if(!crewAssignments[e.crew.id]) {
                        const gapCheck = check10HourGap(e.crew.id, h);
                        if(!gapCheck.valid) return false;
                    }
                    
                    // PREVENT DOUBLE STATION: If already assigned to a DIFFERENT station, skip
                    if(crewAssignments[e.crew.id]?.station && crewAssignments[e.crew.id].station !== stationId) {
                        return false; // Already assigned to another station today
                    }
                    
                    if(crewAssignments[e.crew.id]?.hours[h]) return false;
                    
                    // PREVENT BROKEN SHIFTS: If crew already has hours, only allow adjacent hours
                    const existingHours = Object.keys(crewAssignments[e.crew.id]?.hours || {}).map(x => parseInt(x));
                    if(existingHours.length > 0) {
                        const minHour = Math.min(...existingHours);
                        const maxHour = Math.max(...existingHours);
                        // Only allow hour if it's adjacent (h == minHour - 1 or h == maxHour + 1)
                        // Or if it fills a gap (shouldn't happen but check anyway)
                        if(h !== minHour - 1 && h !== maxHour + 1) {
                            return false; // Would create a broken/split shift
                        }
                    }
                    
                    const assignedHours = Object.keys(crewAssignments[e.crew.id]?.hours || {}).length;
                    if(assignedHours >= maxDutyHours) return false;
                    
                    // Check weekly overtime limit (48 + today's hours)
                    if(e.weeklyHours + assignedHours >= 56) return false; // Hard cap at 56
                    
                    return true;
                });
                
                // Smart sorting with shift preference
                candidates.sort((a, b) => {
                    const aAdj = (crewAssignments[a.crew.id]?.hours[h-1] || crewAssignments[a.crew.id]?.hours[h+1]) ? -50 : 0;
                    const bAdj = (crewAssignments[b.crew.id]?.hours[h-1] || crewAssignments[b.crew.id]?.hours[h+1]) ? -50 : 0;
                    
                    const aSameStation = crewAssignments[a.crew.id]?.station === stationId ? -30 : 0;
                    const bSameStation = crewAssignments[b.crew.id]?.station === stationId ? -30 : 0;
                    
                    const aShiftPref = getShiftPreferenceScore(a.shiftPref, h);
                    const bShiftPref = getShiftPreferenceScore(b.shiftPref, h);
                    
                    const aScore = a.priorityScore + aAdj + aSameStation + aShiftPref;
                    const bScore = b.priorityScore + bAdj + bSameStation + bShiftPref;
                    
                    return aScore - bScore;
                });
                
                let filled = 0;
                for(let i = 0; i < candidates.length && filled < stillNeeded; i++) {
                    const candidate = candidates[i];
                    const crewId = candidate.crew.id;
                    
                    // Double-check: skip if already assigned to different station
                    if(crewAssignments[crewId]?.station && crewAssignments[crewId].station !== stationId) {
                        continue;
                    }
                    
                    if(!crewAssignments[crewId]) {
                        crewAssignments[crewId] = { hours: {}, station: stationId };
                    }
                    crewAssignments[crewId].hours[h] = 1;
                    // Station is locked once assigned - no changes
                    if(!crewAssignments[crewId].station) crewAssignments[crewId].station = stationId;
                    
                    if(candidate.wouldHit6thDay && !sixthDayAssignments.find(s => s.crewId === crewId)) {
                        sixthDayAssignments.push({
                            crewId, crewName: candidate.crew.name, streak: candidate.streak + 1
                        });
                    }
                    
                    filled++;
                }
                
                if(filled < stillNeeded) {
                    unfilledPositions.push({
                        hour: h, station: getStationName(stationId), stationId, needed: stillNeeded - filled
                    });
                }
            });
        }
        
        // ==================== EXTEND TO MIN HOURS ====================
        Object.entries(crewAssignments).forEach(([crewId, assignment]) => {
            const eligibility = crewEligibility.find(e => e.crew.id == crewId);
            if(!eligibility?.availability) return;
            
            const assignedHours = Object.keys(assignment.hours).map(h => parseInt(h)).sort((a,b) => a-b);
            
            while(assignedHours.length > 0 && assignedHours.length < minDutyHours) {
                if(assignedHours.length >= maxDutyHours) break;
                
                const firstHour = Math.min(...assignedHours);
                const lastHour = Math.max(...assignedHours);
                const isHotcakeStation = assignment.station === 'hotcake_eggs';
                
                const prevHour = firstHour - 1;
                const canAddBefore = prevHour >= 0 && !assignment.hours[prevHour] && 
                    (isHotcakeStation ? breakfastHours.includes(prevHour) : true) &&
                    prevHour >= eligibility.availability.start;
                
                const nextHour = lastHour + 1;
                const canAddAfter = nextHour <= 23 && !assignment.hours[nextHour] && 
                    (isHotcakeStation ? breakfastHours.includes(nextHour) : true) &&
                    nextHour < (eligibility.availability.end > 24 ? 24 : eligibility.availability.end);
                
                if(canAddBefore) {
                    assignment.hours[prevHour] = 1;
                    assignedHours.push(prevHour);
                    assignedHours.sort((a,b) => a-b);
                } else if(canAddAfter) {
                    assignment.hours[nextHour] = 1;
                    assignedHours.push(nextHour);
                    assignedHours.sort((a,b) => a-b);
                } else break;
            }
        });
        
        // ==================== OVERTIME TRACKING ====================
        Object.entries(crewAssignments).forEach(([crewId, assignment]) => {
            const todayHours = Object.keys(assignment.hours).length;
            const eligibility = crewEligibility.find(e => e.crew.id == crewId);
            if(!eligibility) return;
            
            const totalWeekly = eligibility.weeklyHours + todayHours;
            
            if(todayHours > 8) {
                overtimeAlerts.push({
                    crewName: eligibility.crew.name,
                    type: 'daily',
                    hours: todayHours,
                    overtime: todayHours - 8
                });
            }
            
            if(totalWeekly > 48) {
                overtimeAlerts.push({
                    crewName: eligibility.crew.name,
                    type: 'weekly',
                    hours: totalWeekly,
                    overtime: totalWeekly - 48
                });
            }
        });
        
        // ==================== AUTO-REST FOR 6TH DAY CREW ====================
        const autoRestApplied = [];
        const nextDateStr = new Date(targetDate.getTime() + 86400000).toISOString().split('T')[0];
        
        sixthDayAssignments.forEach(assignment => {
            // Auto-mark rest for tomorrow
            if(!restData[nextDateStr]) restData[nextDateStr] = {};
            if(!restData[nextDateStr][assignment.crewId]) {
                restData[nextDateStr][assignment.crewId] = true;
                autoRestApplied.push(assignment.crewName);
            }
        });
        
        // ==================== CONVERT TO SCHEDULE FORMAT ====================
        Object.entries(crewAssignments).forEach(([crewId, assignment]) => {
            const hours = Object.keys(assignment.hours).map(h => parseInt(h)).sort((a,b) => a-b);
            if(hours.length === 0) return;
            
            const hoursObj = {};
            hours.forEach(h => hoursObj[h] = 1);
            
            scheduleData[dateStr][crewId] = {
                timeIn: formatHour(hours[0]),
                timeOut: formatHour((hours[hours.length - 1] + 1) % 24),
                meal: hours.length >= 6 ? (Math.random() < 0.5 ? 'A' : 'B') : '',
                hours: hoursObj,
                station: assignment.station
            };
        });
        
        // Save rest data
        saveToLocalStorage();
        
        closeModal('autoFillModal');
        currentDate = targetDate;
        document.getElementById('dateSelect').value = dateStr;
        showSection('daily');
        
        // ==================== GENERATE COMPREHENSIVE REPORT ====================
        const totalScheduled = Object.keys(scheduleData[dateStr]).length;
        const totalGC = Object.values(hourlyGC).reduce((a,b) => a+b, 0);
        const totalHours = Object.values(scheduleData[dateStr]).reduce((sum, entry) => sum + Object.keys(entry.hours).length, 0);
        
        let report = `‚úÖ SMART SCHEDULE GENERATED!\n`;
        report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        report += `üìÖ ${dayNameFull}, ${dateStr}\n`;
        report += `üìä GC: ${totalGC} | üë• Crew: ${totalScheduled} | ‚è±Ô∏è Hours: ${totalHours}\n\n`;
        
        // Show Crew Trainer assignments per shift
        report += `‚≠ê CREW TRAINERS BY SHIFT:\n`;
        report += `‚Ä¢ Open (5AM-11AM): ${assignedTrainers.open.length > 0 ? assignedTrainers.open.join(', ') : '‚ö†Ô∏è None'}\n`;
        report += `‚Ä¢ Mid (10AM-5PM): ${assignedTrainers.mid.length > 0 ? assignedTrainers.mid.join(', ') : '‚ö†Ô∏è None'}\n`;
        report += `‚Ä¢ Close (5PM-12MN): ${assignedTrainers.close.length > 0 ? assignedTrainers.close.join(', ') : '‚ö†Ô∏è None'}\n\n`;
        
        report += `üîç PRE-FLIGHT CHECK:\n`;
        report += `‚Ä¢ Eligible: ${eligibleCrew.length} | Blocked: ${blockedCrew.length}\n`;
        report += `‚Ä¢ Crew Trainers Available: ${crewTrainers.length}\n`;
        if(blockedCrew.length > 0) {
            const reasons = {};
            blockedCrew.forEach(b => { reasons[b.reason] = (reasons[b.reason] || 0) + 1; });
            Object.entries(reasons).slice(0, 4).forEach(([reason, count]) => {
                report += `  ‚îî ${reason}: ${count}\n`;
            });
        }
        
        if(skillGapWarnings.length > 0) {
            report += `\nüö® SKILL GAP ALERTS (${skillGapWarnings.length}):\n`;
            skillGapWarnings.slice(0, 3).forEach(w => {
                report += `‚Ä¢ ${w.station}: Need ${w.needed}, Have ${w.available}\n`;
            });
        }
        
        if(overtimeAlerts.length > 0) {
            report += `\n‚è∞ OVERTIME ALERTS (${overtimeAlerts.length}):\n`;
            const dailyOT = overtimeAlerts.filter(o => o.type === 'daily');
            const weeklyOT = overtimeAlerts.filter(o => o.type === 'weekly');
            if(dailyOT.length > 0) report += `‚Ä¢ Daily OT (>8hrs): ${dailyOT.length} crew\n`;
            if(weeklyOT.length > 0) report += `‚Ä¢ Weekly OT (>48hrs): ${weeklyOT.length} crew\n`;
        }
        
        if(sixthDayAssignments.length > 0) {
            report += `\n‚ö†Ô∏è 6TH DAY DUTY (${sixthDayAssignments.length}):\n`;
            sixthDayAssignments.slice(0, 3).forEach(s => {
                report += `‚Ä¢ ${s.crewName}\n`;
            });
        }
        
        if(autoRestApplied.length > 0) {
            report += `\nüåô AUTO-REST APPLIED FOR TOMORROW:\n`;
            autoRestApplied.slice(0, 3).forEach(name => {
                report += `‚Ä¢ ${name}\n`;
            });
            if(autoRestApplied.length > 3) report += `  ... and ${autoRestApplied.length - 3} more\n`;
        }
        
        if(unfilledPositions.length > 0) {
            report += `\n‚ùå UNFILLED (${unfilledPositions.length}):\n`;
            unfilledPositions.slice(0, 3).forEach(u => {
                report += `‚Ä¢ ${u.station} @ ${formatHour(u.hour)}\n`;
            });
        }
        
        report += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        report += `‚úì Crew Trainers Prioritized\n`;
        report += `‚úì 10-Hour Gap Rule Applied\n`;
        report += `‚úì Shift Preferences Considered\n`;
        report += `‚úì Workload Balanced\n`;
        report += `‚òÅÔ∏è Saved to Cloud\n`;
        
        // Save to Firestore
        saveScheduleToFirestore(dateStr);
        if(autoRestApplied.length > 0) {
            saveRestToFirestore();
        }
        
        alert(report);
    }

    function parseAvailability(availStr) {
        if(!availStr || availStr === '') return null;
        if(availStr === '12AM-12AM') return { start: 0, end: 24 };
        const match = availStr.match(/(\d+)(AM|PM)-(\d+)(AM|PM)/i);
        if(!match) return { start: 6, end: 22 };
        let startHr = parseInt(match[1]);
        if(match[2].toUpperCase() === 'PM' && startHr !== 12) startHr += 12;
        if(match[2].toUpperCase() === 'AM' && startHr === 12) startHr = 0;
        let endHr = parseInt(match[3]);
        if(match[4].toUpperCase() === 'PM' && endHr !== 12) endHr += 12;
        if(match[4].toUpperCase() === 'AM' && endHr === 12) endHr = 24;
        if(endHr < startHr) endHr += 24;
        return { start: startHr, end: Math.min(endHr, 24) };
    }
    window.runAutoFill = runAutoFill;

    function formatHour(h) {
        h = h % 24;
        return (h % 12 || 12) + (h < 12 ? 'AM' : 'PM');
    }

    // ==================== CREW MANAGEMENT ====================
    function openAddCrewModal() {
        document.getElementById('newCrewName').value = '';
        
        // Build station checkboxes
        let html = '';
        Object.entries(AREAS).forEach(([areaId, area]) => {
            const stations = stationsData[areaId] || [];
            stations.forEach(station => {
                html += `<label style="display:flex;align-items:center;gap:6px;font-size:11px;padding:4px;cursor:pointer;">
                    <input type="checkbox" name="crewStation" value="${station.id}"> ${station.name}
                </label>`;
            });
        });
        document.getElementById('stationCheckboxes').innerHTML = html;
        
        document.getElementById('addCrewModal').classList.add('show');
    }
    window.openAddCrewModal = openAddCrewModal;

    function addNewCrew() {
        const name = document.getElementById('newCrewName').value.trim().toUpperCase();
        const section = document.getElementById('newCrewSection').value;
        const position = document.getElementById('newCrewPosition').value;
        
        if(!name) { showToast('‚ö†Ô∏è Please enter crew name', 'error'); return; }
        
        const selectedStations = [];
        document.querySelectorAll('input[name="crewStation"]:checked').forEach(cb => {
            selectedStations.push(cb.value);
        });
        
        const newId = Math.max(...crewData.map(c => c.id), 0) + 1;
        crewData.push({
            id: newId,
            name,
            section,
            position: position,
            stations: selectedStations,
            availability: {mon:'12AM-12AM',tue:'12AM-12AM',wed:'12AM-12AM',thu:'12AM-12AM',fri:'12AM-12AM',sat:'12AM-12AM',sun:'12AM-12AM'}
        });
        
        saveToLocalStorage();
        closeModal('addCrewModal');
        renderCrew();
        showToast(`‚úÖ Crew "${name}" added as ${position}!`, 'success');
    }
    window.addNewCrew = addNewCrew;

    // ==================== RENDER FUNCTIONS ====================
    function showSection(section) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`[data-section="${section}"]`)?.classList.add('active');
        document.querySelectorAll('.content > section').forEach(s => s.style.display = 'none');
        document.getElementById(`${section}-section`).style.display = 'block';
        
        const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        const selectedMonth = months[parseInt(document.getElementById('monthSelect').value)];
        const selectedYear = document.getElementById('yearSelect').value;
        
        const titles = {
            dashboard: ['Dashboard', 'Overview of crew scheduling'],
            daily: ['Crew Scheduling', 'Manage daily crew assignments'],
            npg: ['Positioning Guide (NPG)', 'Configure crew positions by area'],
            monthly: ['Monthly Rotation', `${selectedMonth} ${selectedYear} - View monthly schedule`],
            rest: ['Rest Calendar', `${selectedMonth} ${selectedYear} - Track rest days`],
            crew: ['Crew Masterlist', 'Manage crew members'],
            reports: ['Reports', `${selectedMonth} ${selectedYear} - Analytics`]
        };
        const pageTitleEl = document.getElementById('pageTitle');
        const pageSubtitleEl = document.getElementById('pageSubtitle');
        if(pageTitleEl) pageTitleEl.textContent = titles[section]?.[0] || section;
        if(pageSubtitleEl) pageSubtitleEl.textContent = titles[section]?.[1] || '';
        
        renderAll();
    }

    function renderAll() {
        renderDashboard();
        renderNPG();
        renderDaily();
        renderMonthly();
        renderRest();
        renderCrew();
        renderReports();
    }

    function renderDashboard() {
        const dateKey = currentDate.toISOString().split('T')[0];
        const daySchedule = scheduleData[dateKey] || {};
        const dayName = ['sun','mon','tue','wed','thu','fri','sat'][currentDate.getDay()];
        const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        const daysOfWeek = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        
        // Update available crew date label
        const availableCrewDate = document.getElementById('availableCrewDate');
        if(availableCrewDate) {
            availableCrewDate.textContent = daysOfWeek[currentDate.getDay()] + ', ' + months[currentDate.getMonth()] + ' ' + currentDate.getDate() + ', ' + currentDate.getFullYear();
        }
        
        // Count active crew
        const activeCrew = crewData.filter(c => c.status !== 'inactive').length;
        const statTotalCrew = document.getElementById('statTotalCrew');
        if(statTotalCrew) statTotalCrew.textContent = activeCrew;
        
        // Count scheduled crew (those with hours)
        const scheduledCrewIds = Object.keys(daySchedule).filter(id => {
            const entry = daySchedule[id];
            return entry && Object.keys(entry.hours || {}).length > 0;
        });
        const statScheduledToday = document.getElementById('statScheduledToday');
        if(statScheduledToday) statScheduledToday.textContent = scheduledCrewIds.length;
        
        // Find available crew
        const availableCrew = [];
        const onRestCrew = [];
        
        crewData.forEach(crew => {
            // Skip inactive crew
            if(crew.status === 'inactive') return;
            
            // Check if already scheduled
            const isScheduled = scheduledCrewIds.includes(String(crew.id)) || scheduledCrewIds.includes(crew.id);
            if(isScheduled) return;
            
            // Check if on rest (from Rest Calendar)
            const isOnRestCalendar = restData[dateKey]?.[crew.id] === true;
            if(isOnRestCalendar) {
                onRestCrew.push(crew);
                return;
            }
            
            // Check availability for this day of week
            const availability = crew.availability?.[dayName];
            const isOffDay = !availability || availability === '' || availability.toUpperCase() === 'OFF';
            if(isOffDay) {
                onRestCrew.push(crew);
                return;
            }
            
            // Crew is available
            availableCrew.push({
                crew: crew,
                availability: availability
            });
        });
        
        // Update stats
        const statAvailableCrew = document.getElementById('statAvailableCrew');
        if(statAvailableCrew) statAvailableCrew.textContent = availableCrew.length;
        
        const statOnRest = document.getElementById('statOnRest');
        if(statOnRest) statOnRest.textContent = onRestCrew.length;
        
        // Render available crew list
        const availableCrewList = document.getElementById('availableCrewList');
        if(availableCrewList) {
            if(availableCrew.length === 0) {
                availableCrewList.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#666;">
                        <div style="font-size:48px;margin-bottom:15px;">‚úÖ</div>
                        <p style="font-size:14px;">All available crew are scheduled!</p>
                        <p style="font-size:11px;color:#888;">No unscheduled crew for today.</p>
                    </div>
                `;
            } else {
                let html = `
                    <table style="width:100%;border-collapse:collapse;">
                        <thead>
                            <tr style="background:rgba(0,0,0,0.3);">
                                <th style="padding:12px;text-align:left;font-size:11px;color:#888;">NAME</th>
                                <th style="padding:12px;text-align:center;font-size:11px;color:#888;">AVAILABILITY</th>
                                <th style="padding:12px;text-align:left;font-size:11px;color:#888;">AREAS TRAINED</th>
                                <th style="padding:12px;text-align:center;font-size:11px;color:#888;">SHIFT PREF</th>
                                <th style="padding:12px;text-align:center;font-size:11px;color:#888;">ACTION</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                availableCrew.forEach(({crew, availability}) => {
                    // Get trained areas
                    const trainedAreas = [];
                    const trainedStations = crew.stations || [];
                    
                    Object.entries(stationsData).forEach(([areaId, stations]) => {
                        const hasStationInArea = stations.some(s => trainedStations.includes(s.id));
                        if(hasStationInArea) {
                            const areaInfo = AREAS[areaId];
                            if(areaInfo) {
                                trainedAreas.push({
                                    icon: areaInfo.icon,
                                    name: areaInfo.name,
                                    color: areaInfo.color
                                });
                            }
                        }
                    });
                    
                    // Shift preference
                    const shiftPref = crew.shiftPreference || 'any';
                    const shiftLabels = {
                        'any': { label: 'Any', color: '#6b7280', icon: '‚è∞' },
                        'morning': { label: 'Morning', color: '#fbbf24', icon: 'üåÖ' },
                        'mid': { label: 'Mid', color: '#10b981', icon: '‚òÄÔ∏è' },
                        'evening': { label: 'Evening', color: '#3b82f6', icon: 'üåÜ' },
                        'graveyard': { label: 'Graveyard', color: '#8b5cf6', icon: 'üåô' }
                    };
                    const shiftInfo = shiftLabels[shiftPref] || shiftLabels['any'];
                    
                    html += `
                        <tr style="border-bottom:1px solid #333;">
                            <td style="padding:12px;">
                                <div style="font-weight:600;color:#fff;">${crew.name}</div>
                                <div style="font-size:10px;color:#888;">${crew.section || ''}</div>
                            </td>
                            <td style="padding:12px;text-align:center;">
                                <span style="background:rgba(16,185,129,0.2);color:#10b981;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600;">
                                    ${availability}
                                </span>
                            </td>
                            <td style="padding:12px;">
                                <div style="display:flex;flex-wrap:wrap;gap:5px;">
                                    ${trainedAreas.map(area => `
                                        <span style="background:${area.color}20;color:${area.color};padding:2px 8px;border-radius:3px;font-size:10px;">
                                            ${area.icon} ${area.name}
                                        </span>
                                    `).join('')}
                                </div>
                            </td>
                            <td style="padding:12px;text-align:center;">
                                <span style="color:${shiftInfo.color};font-size:11px;">
                                    ${shiftInfo.icon} ${shiftInfo.label}
                                </span>
                            </td>
                            <td style="padding:12px;text-align:center;">
                                <button onclick="addCrewToScheduleFromDashboard('${crew.id}')" 
                                    style="background:#10b981;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:10px;font-weight:600;">
                                    ‚ûï Add to Schedule
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                availableCrewList.innerHTML = html;
            }
        }
        
        // Today overview by area
        const todayOverview = document.getElementById('todayOverview');
        if(todayOverview) {
            let overviewHtml = '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;">';
            Object.entries(AREAS).forEach(([areaId, area]) => {
                let count = 0;
                crewData.forEach(crew => {
                    if(daySchedule[crew.id]) {
                        const stationArea = Object.keys(stationsData).find(a => stationsData[a].some(s => s.id === daySchedule[crew.id].station));
                        if(stationArea === areaId) count++;
                    }
                });
                overviewHtml += `<div style="background:${area.color}15;padding:15px;border-radius:10px;border-left:4px solid ${area.color};">
                    <p style="color:#888;font-size:11px;">${area.icon} ${area.name}</p>
                    <p style="font-size:24px;font-weight:700;color:${area.color};">${count}</p>
                </div>`;
            });
            overviewHtml += '</div>';
            todayOverview.innerHTML = overviewHtml;
        }
    }
    
    function addCrewToScheduleFromDashboard(crewId) {
        // Navigate to Crew Scheduling
        showSection('daily');
        
        // Alert user to add the crew manually
        const crew = crewData.find(c => c.id == crewId);
        if(crew) {
            alert('üìã Navigating to Crew Scheduling.\n\nTo add "' + crew.name + '":\n1. Click "+ Add Crew" in their section (' + crew.section + ')\n2. Or use Auto-Fill with GC to schedule automatically.');
        }
    }
    
    window.addCrewToScheduleFromDashboard = addCrewToScheduleFromDashboard;

    function renderDaily() {
        const dateKey = currentDate.toISOString().split('T')[0];
        if(!scheduleData[dateKey]) scheduleData[dateKey] = {};
        const daySchedule = scheduleData[dateKey];
        const dayGC = gcForecast[dateKey] || {};
        const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        const daysOfWeek = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        const dayOfWeek = daysOfWeek[currentDate.getDay()];
        
        // Check if schedule is locked
        const isLocked = isScheduleLocked(dateKey);
        
        // Update lock status and buttons
        const lockStatus = document.getElementById('scheduleLockStatus');
        const btnReset = document.getElementById('btnResetSchedule');
        const btnAutoFill = document.getElementById('btnAutoFill');
        const btnSave = document.getElementById('btnSaveSchedule');
        const btnEdit = document.getElementById('btnEditSchedule');
        
        if(lockStatus) {
            lockStatus.style.display = isLocked ? 'inline-block' : 'none';
        }
        if(btnReset) {
            btnReset.style.display = isLocked ? 'none' : 'inline-block';
        }
        if(btnAutoFill) {
            btnAutoFill.style.display = isLocked ? 'none' : 'inline-block';
        }
        if(btnSave) {
            btnSave.style.display = isLocked ? 'none' : 'inline-block';
        }
        if(btnEdit) {
            btnEdit.style.display = isLocked ? 'inline-block' : 'none';
        }
        
        // Update header date display
        const scheduleDateEl = document.getElementById('scheduleDate');
        if(scheduleDateEl) {
            scheduleDateEl.textContent = `${months[currentDate.getMonth()]} ${currentDate.getDate()}, ${currentDate.getFullYear()}`;
        }
        
        // Update full date display bar
        const scheduleDateFull = document.getElementById('scheduleDateFull');
        const scheduleDateSub = document.getElementById('scheduleDateSub');
        const dayOfWeekEl = document.getElementById('dayOfWeek');
        
        if(scheduleDateFull) {
            scheduleDateFull.textContent = `${dayOfWeek}, ${months[currentDate.getMonth()]} ${currentDate.getDate()}, ${currentDate.getFullYear()}`;
        }
        if(scheduleDateSub) {
            const lockLabel = isLocked ? ' üîí LOCKED' : '';
            scheduleDateSub.textContent = `Crew Schedule for ${dateKey}${lockLabel}`;
        }
        if(dayOfWeekEl) {
            dayOfWeekEl.textContent = dayOfWeek;
            // Color weekends differently
            if(currentDate.getDay() === 0 || currentDate.getDay() === 6) {
                dayOfWeekEl.style.color = '#ef4444'; // Red for weekends
            } else {
                dayOfWeekEl.style.color = '#fbbf24'; // Yellow for weekdays
            }
        }
        
        // Breakfast hours (4:30AM - 10:30AM = hours 4,5,6,7,8,9,10)
        const breakfastHours = [4, 5, 6, 7, 8, 9, 10];
        // Graveyard hours (10PM - 6AM = hours 22,23,0,1,2,3,4,5)
        const graveyardHours = [22, 23, 0, 1, 2, 3, 4, 5];
        
        // Header with 24 hours (12AM to 11PM)
        let headHtml = '<tr><th class="name-col">NAME</th><th>STATION</th><th>TOTAL</th><th>TIME</th><th>MEAL</th>';
        
        // Hours 12AM-11AM (0-11)
        for(let h = 0; h <= 11; h++) {
            const label = h === 0 ? '12A' : `${h}A`;
            const isBreakfast = breakfastHours.includes(h);
            const isGraveyard = graveyardHours.includes(h);
            let bgStyle = '';
            let title = '';
            if(isGraveyard && isBreakfast) {
                bgStyle = 'background:linear-gradient(135deg,#92400e,#1e293b);';
                title = 'Graveyard + Breakfast';
            } else if(isGraveyard) {
                bgStyle = 'background:linear-gradient(135deg,#1e293b,#0f172a);';
                title = 'Graveyard';
            } else if(isBreakfast) {
                bgStyle = 'background:linear-gradient(135deg,#92400e,#78350f);';
                title = 'Breakfast';
            }
            headHtml += `<th class="hour-col" style="${bgStyle}" title="${title}">${label}</th>`;
        }
        // Hours 12PM-11PM (12-23)
        for(let h = 12; h <= 23; h++) {
            const label = h === 12 ? '12P' : `${h-12}P`;
            const isGraveyard = graveyardHours.includes(h);
            const bgStyle = isGraveyard ? 'background:linear-gradient(135deg,#1e293b,#0f172a);' : '';
            const title = isGraveyard ? 'Graveyard' : '';
            headHtml += `<th class="hour-col" style="${bgStyle}" title="${title}">${label}</th>`;
        }
        headHtml += '<th style="width:40px;">üóëÔ∏è</th>';
        headHtml += '</tr>';
        const dailyHeadEl = document.getElementById('dailyHead');
        if(dailyHeadEl) dailyHeadEl.innerHTML = headHtml;
        
        let bodyHtml = '';
        
        // GC Row
        let totalGC = 0;
        for(let h = 0; h <= 23; h++) totalGC += (dayGC[h] || 0);
        
        bodyHtml += '<tr class="gc-row"><td>üìä GC</td><td></td><td>' + totalGC + '</td><td></td><td></td>';
        for(let h = 0; h <= 23; h++) {
            const isBreakfast = breakfastHours.includes(h);
            const isGraveyard = graveyardHours.includes(h);
            let bg = '';
            if(isGraveyard) bg = 'background:rgba(30,41,59,0.5);';
            else if(isBreakfast) bg = 'background:rgba(251,191,36,0.3);';
            bodyHtml += `<td style="${bg}">${dayGC[h] || ''}</td>`;
        }
        bodyHtml += '<td></td></tr>';
        
        // Shift row
        bodyHtml += '<tr style="background:rgba(0,0,0,0.3);"><td colspan="5" style="text-align:left;padding-left:15px;font-size:10px;color:#888;">SHIFT</td>';
        for(let h = 0; h <= 23; h++) {
            const isBreakfast = breakfastHours.includes(h);
            const isGraveyard = graveyardHours.includes(h);
            let icon = 'üçî'; let color = '#10b981';
            if(isGraveyard) { icon = 'üåô'; color = '#94a3b8'; }
            else if(isBreakfast) { icon = 'üç≥'; color = '#fbbf24'; }
            bodyHtml += `<td style="font-size:9px;color:${color};">${icon}</td>`;
        }
        bodyHtml += '<td></td></tr>';
        
        // Updated sections including BEVCEL & FRIES
        const sections = ['PRODUCTION', 'SERVICE', 'BEVCEL_FRIES', 'DRIVE THRU', 'CUSTOMER_AREA', 'MDS', 'MARKETING', 'OTHERS'];
        const sectionLabels = {
            'PRODUCTION': 'PRODUCTION',
            'SERVICE': 'SERVICE',
            'BEVCEL_FRIES': 'BEVCEL & FRIES',
            'DRIVE THRU': 'DRIVE THRU',
            'CUSTOMER_AREA': 'CUSTOMER AREA',
            'MDS': 'MDS',
            'MARKETING': 'MARKETING',
            'OTHERS': 'OTHERS'
        };
        let hourCounts = {};
        
        sections.forEach((section, sectionIdx) => {
            const sectionCrew = crewData.filter(c => c.section === section);
            const sectionLabel = sectionLabels[section] || section;
            
            // Get manual entries for this section
            const manualEntries = Object.entries(daySchedule).filter(([id, entry]) => {
                return entry.isTemp && entry.section === section;
            });
            
            // Section header with Add Crew button - use data attribute to avoid quote issues
            bodyHtml += `<tr class="section-row">
                <td colspan="30" style="position:relative;">
                    ${sectionLabel}
                    ${isLocked ? '' : '<button class="add-crew-btn" data-section="' + section.replace(/"/g, '&quot;') + '" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);padding:3px 10px;font-size:10px;background:#10b981;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:600;">+ Add Crew</button>'}
                </td>
            </tr>`;
            
            // ONLY show crew who have scheduled hours for this day (or are on rest)
            sectionCrew.forEach(crew => {
                const isInactive = crew.status === 'inactive';
                const isOnRest = restData[dateKey]?.[crew.id] === true;
                const entry = daySchedule[crew.id];
                const rowTotal = entry ? Object.keys(entry.hours || {}).length : 0;
                
                // Skip crew who are not scheduled AND not on rest (unless inactive which we might want to show)
                // Only show: crew with hours > 0, or crew on rest day
                if(rowTotal === 0 && !isOnRest) {
                    return; // Don't show this crew - they're not scheduled
                }
                
                const stationName = entry?.station ? getStationName(entry.station) : '';
                const isHotcakeStation = entry?.station === 'hotcake_eggs';
                
                // Style for inactive or rest crew
                let rowStyle = '';
                let nameStyle = '';
                let statusLabel = '';
                let isDisabled = false;
                
                if(isInactive) {
                    rowStyle = 'opacity:0.4;background:rgba(239,68,68,0.05);';
                    nameStyle = 'text-decoration:line-through;color:#ef4444;';
                    statusLabel = ' <span style="font-size:8px;color:#ef4444;">[INACTIVE]</span>';
                    isDisabled = true;
                } else if(isOnRest) {
                    rowStyle = 'opacity:0.5;background:rgba(251,191,36,0.1);';
                    nameStyle = 'color:#fbbf24;';
                    statusLabel = ' <span style="font-size:8px;color:#fbbf24;font-weight:bold;">[REST]</span>';
                    isDisabled = true;
                }
                
                bodyHtml += `<tr data-crew-id="${crew.id}" style="${rowStyle}"><td class="name-cell" style="${nameStyle}">${crew.name}${statusLabel}</td>`;
                bodyHtml += `<td class="station-cell">${stationName}${isHotcakeStation ? ' üç≥' : ''}</td>`;
                bodyHtml += `<td class="total-cell" id="total-${crew.id}">${rowTotal || ''}</td>`;
                bodyHtml += `<td style="font-size:10px;" id="time-${crew.id}">${entry ? entry.timeIn+'-'+entry.timeOut : ''}</td>`;
                bodyHtml += `<td class="meal-cell ${entry?.meal === 'A' ? 'meal-a' : (entry?.meal === 'B' ? 'meal-b' : '')}">${entry?.meal || ''}</td>`;
                
                // 24 hour cells - EDITABLE (but visually disabled for inactive/rest)
                for(let h = 0; h <= 23; h++) {
                    const filled = entry?.hours?.[h];
                    if(filled) hourCounts[h] = (hourCounts[h]||0) + 1;
                    const isBreakfast = breakfastHours.includes(h);
                    const isGraveyard = graveyardHours.includes(h);
                    let bgExtra = '';
                    if(isGraveyard && !filled) bgExtra = 'background:rgba(30,41,59,0.2);';
                    else if(isBreakfast && !filled) bgExtra = 'background:rgba(251,191,36,0.05);';
                    
                    bodyHtml += `<td class="hour-cell ${filled?'filled':''}" style="${bgExtra}">
                        <input type="text" value="${filled?'‚óè':''}" data-crew-id="${crew.id}" data-hour="${h}" maxlength="1"
                            onkeydown="handleHourKeydown(event, this)" onclick="this.select()" style="cursor:pointer;" ${isDisabled || isLocked ? 'disabled title="' + (isLocked ? 'Schedule is locked' : (isInactive ? 'Crew is inactive' : 'Crew is on rest day')) + '"' : ''}>
                    </td>`;
                }
                // Delete button for this crew's schedule (hidden when locked)
                bodyHtml += `<td style="text-align:center;">
                    ${isLocked ? '<span style="color:#666;font-size:10px;">üîí</span>' : '<button onclick="deleteCrewSchedule(\'' + crew.id + '\')" style="background:#ef4444;color:#fff;border:none;padding:3px 6px;border-radius:3px;cursor:pointer;font-size:10px;" title="Remove ' + crew.name + ' from schedule">‚úï</button>'}
                </td>`;
                bodyHtml += '</tr>';
            });
            
            // Render manual/temp entries for this section
            manualEntries.forEach(([tempId, entry]) => {
                const rowTotal = Object.keys(entry.hours || {}).length;
                
                bodyHtml += `<tr data-crew-id="${tempId}" style="background:rgba(16,185,129,0.1);">`;
                // Editable NAME cell
                bodyHtml += `<td class="name-cell" style="padding:0;">
                    <input type="text" value="${entry.tempName || ''}" placeholder="Enter name..." 
                        data-temp-id="${tempId}" 
                        onchange="updateTempCrewName(this, '${tempId}')" onblur="updateTempCrewName(this, '${tempId}')"
                        style="width:100%;padding:8px;background:transparent;border:1px dashed #10b981;color:#fff;font-size:11px;" ${isLocked ? 'disabled' : ''}>
                </td>`;
                // Editable STATION cell
                bodyHtml += `<td class="station-cell" style="padding:0;">
                    <input type="text" value="${entry.station || ''}" placeholder="Station..." 
                        data-temp-id="${tempId}"
                        onchange="updateTempCrewStation(this, '${tempId}')" onblur="updateTempCrewStation(this, '${tempId}')"
                        style="width:100%;padding:8px;background:transparent;border:1px dashed #10b981;color:#fff;font-size:10px;" ${isLocked ? 'disabled' : ''}>
                </td>`;
                bodyHtml += `<td class="total-cell" id="total-${tempId}">${rowTotal || ''}</td>`;
                bodyHtml += `<td style="font-size:10px;" id="time-${tempId}">${entry.timeIn && entry.timeOut ? entry.timeIn+'-'+entry.timeOut : ''}</td>`;
                bodyHtml += `<td class="meal-cell"></td>`;
                
                // 24 hour cells - EDITABLE (disabled when locked)
                for(let h = 0; h <= 23; h++) {
                    const filled = entry.hours?.[h];
                    if(filled) hourCounts[h] = (hourCounts[h]||0) + 1;
                    const isBreakfast = breakfastHours.includes(h);
                    const isGraveyard = graveyardHours.includes(h);
                    let bgExtra = '';
                    if(isGraveyard && !filled) bgExtra = 'background:rgba(30,41,59,0.2);';
                    else if(isBreakfast && !filled) bgExtra = 'background:rgba(251,191,36,0.05);';
                    
                    bodyHtml += `<td class="hour-cell ${filled?'filled':''}" style="${bgExtra}">
                        <input type="text" value="${filled?'‚óè':''}" data-crew-id="${tempId}" data-hour="${h}" maxlength="1"
                            onkeydown="handleHourKeydown(event, this)" onclick="this.select()" style="cursor:pointer;" ${isLocked ? 'disabled title="Schedule is locked"' : ''}>
                    </td>`;
                }
                // Delete button in last column (hidden when locked)
                bodyHtml += `<td style="text-align:center;">
                    ${isLocked ? '<span style="color:#666;font-size:10px;">üîí</span>' : '<button onclick="removeTempCrew(\'' + tempId + '\')" style="background:#ef4444;color:#fff;border:none;padding:3px 6px;border-radius:3px;cursor:pointer;font-size:10px;" title="Remove from schedule">‚úï</button>'}
                </td>`;
                bodyHtml += '</tr>';
            });
        });
        
        // Summary row
        bodyHtml += '<tr class="summary-row"><td>TOTAL/HOUR</td><td></td><td></td><td></td><td></td>';
        for(let h = 0; h <= 23; h++) bodyHtml += `<td id="hourcount-${h}">${hourCounts[h]||0}</td>`;
        bodyHtml += '<td></td></tr>';
        
        const dailyBodyEl = document.getElementById('dailyBody');
        if(dailyBodyEl) dailyBodyEl.innerHTML = bodyHtml;
        
        // Attach click handlers to Add Crew buttons
        document.querySelectorAll('.add-crew-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const section = this.getAttribute('data-section');
                openAddCrewToSchedule(section);
            });
        });
        
        // Calculate and display labor metrics
        calculateLaborMetrics();
    }
    
    function calculateNetSales() {
        const grossSales = parseFloat(document.getElementById('grossSales')?.value) || 0;
        const netSales = grossSales / 1.12; // Remove 12% VAT
        
        const netSalesEl = document.getElementById('netSales');
        if(netSalesEl) {
            if(grossSales > 0) {
                netSalesEl.value = '‚Ç±' + netSales.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            } else {
                netSalesEl.value = '';
            }
        }
        
        return netSales;
    }
    
    function calculateLaborMetrics() {
        const dateKey = currentDate.toISOString().split('T')[0];
        const daySchedule = scheduleData[dateKey] || {};
        const dayGC = gcForecast[dateKey] || {};
        const defaultRate = parseFloat(document.getElementById('hourlyRate')?.value) || 62.50;
        
        // Get Net Sales (Gross √∑ 1.12) for labor % calculation
        const grossSales = parseFloat(document.getElementById('grossSales')?.value) || 0;
        const netSales = grossSales / 1.12;
        
        // Night premium hours (10PM-6AM = 22,23,0,1,2,3,4,5)
        const nightPremiumHours = [22, 23, 0, 1, 2, 3, 4, 5];
        
        let totalRegularHours = 0;
        let totalNightHours = 0;
        let totalGC = 0;
        let totalRegularCost = 0;
        let totalNightCost = 0;
        
        // Calculate total GC
        for(let h = 0; h <= 23; h++) {
            totalGC += (dayGC[h] || 0);
        }
        
        // Calculate hours and cost for each scheduled crew
        Object.entries(daySchedule).forEach(([crewId, entry]) => {
            if(!entry.hours) return;
            
            // Get crew's hourly rate (or default if temp/not found)
            let hourlyRate = defaultRate;
            const crew = crewData.find(c => c.id == crewId);
            if(crew && crew.hourlyRate) {
                hourlyRate = crew.hourlyRate;
            }
            
            Object.keys(entry.hours).forEach(h => {
                const hour = parseInt(h);
                if(nightPremiumHours.includes(hour)) {
                    totalNightHours++;
                    totalNightCost += hourlyRate * 1.10; // 10% night premium
                } else {
                    totalRegularHours++;
                    totalRegularCost += hourlyRate;
                }
            });
        });
        
        const totalHours = totalRegularHours + totalNightHours;
        const totalLaborCost = totalRegularCost + totalNightCost;
        
        // Calculate actual night premium based on individual rates
        let actualNightPremium = 0;
        Object.entries(daySchedule).forEach(([crewId, entry]) => {
            if(!entry.hours) return;
            let hourlyRate = defaultRate;
            const crew = crewData.find(c => c.id == crewId);
            if(crew && crew.hourlyRate) hourlyRate = crew.hourlyRate;
            
            Object.keys(entry.hours).forEach(h => {
                const hour = parseInt(h);
                if(nightPremiumHours.includes(hour)) {
                    actualNightPremium += hourlyRate * 0.10; // Just the 10% premium
                }
            });
        });
        
        // Labor percentage based on NET SALES (not gross)
        const laborPercent = netSales > 0 ? (totalLaborCost / netSales * 100) : 0;
        
        // Update display
        document.getElementById('totalGCInput').value = totalGC || 0;
        document.getElementById('totalLaborHours').value = `${totalHours} (${totalNightHours} night)`;
        document.getElementById('laborCostEst').value = '‚Ç±' + totalLaborCost.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('laborPercent').value = netSales > 0 ? laborPercent.toFixed(2) + '%' : '‚Äî';
        document.getElementById('nightPremium').value = '‚Ç±' + actualNightPremium.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        // Color code labor percent
        const laborPercentEl = document.getElementById('laborPercent');
        if(netSales > 0) {
            if(laborPercent > 25) {
                laborPercentEl.style.color = '#ef4444'; // Red - too high
            } else if(laborPercent > 20) {
                laborPercentEl.style.color = '#f97316'; // Orange - warning
            } else if(laborPercent > 15) {
                laborPercentEl.style.color = '#fbbf24'; // Yellow - okay
            } else {
                laborPercentEl.style.color = '#10b981'; // Green - good
            }
        }
    }

    // Handle keyboard input for hour cells
    function handleHourKeydown(event, input) {
        const crewId = input.dataset.crewId; // Keep as string to support temp IDs
        const hour = parseInt(input.dataset.hour);
        const dateKey = currentDate.toISOString().split('T')[0];
        
        if(!scheduleData[dateKey]) scheduleData[dateKey] = {};
        if(!scheduleData[dateKey][crewId]) {
            scheduleData[dateKey][crewId] = { hours: {}, station: '', timeIn: '', timeOut: '', meal: '' };
        }
        
        const entry = scheduleData[dateKey][crewId];
        
        // FILL: 1, ., Space, x, X, *
        if(['1', '.', ' ', 'x', 'X', '*'].includes(event.key)) {
            event.preventDefault();
            
            // Check current hours BEFORE adding new one
            const currentHours = Object.keys(entry.hours || {}).length;
            
            // If already at 8 or more hours, show warning
            if(currentHours >= 8 && !entry.hours[hour]) {
                // Get crew name for the warning
                let crewName = 'This crew';
                const crew = crewData.find(c => c.id == crewId);
                if(crew) {
                    crewName = crew.name;
                } else if(entry.tempName) {
                    crewName = entry.tempName;
                }
                
                const proceed = confirm(
                    `‚ö†Ô∏è OVERTIME WARNING!\n\n` +
                    `"${crewName}" already has ${currentHours} hours scheduled.\n\n` +
                    `Adding more hours will exceed the 8-hour limit.\n` +
                    `This will result in overtime pay.\n\n` +
                    `Do you want to proceed anyway?`
                );
                
                if(!proceed) {
                    return; // Don't add the hour
                }
            }
            
            entry.hours[hour] = 1;
            input.value = '‚óè';
            input.parentElement.classList.add('filled');
            updateCrewTotals(crewId, dateKey);
            updateHourCounts(dateKey);
            calculateLaborMetrics();
            moveToNextCell(input);
        }
        // CLEAR: 0, Delete, Backspace
        else if(['0', 'Delete', 'Backspace'].includes(event.key)) {
            event.preventDefault();
            delete entry.hours[hour];
            input.value = '';
            input.parentElement.classList.remove('filled');
            updateCrewTotals(crewId, dateKey);
            updateHourCounts(dateKey);
            calculateLaborMetrics();
        }
        // Navigation: Enter, Tab, Arrows
        else if(event.key === 'Enter' || event.key === 'Tab') {
            event.preventDefault();
            moveToNextCell(input);
        }
        else if(event.key === 'ArrowRight') { event.preventDefault(); moveToNextCell(input); }
        else if(event.key === 'ArrowLeft') { event.preventDefault(); moveToPrevCell(input); }
        else if(event.key === 'ArrowDown') { event.preventDefault(); moveToNextRow(input); }
        else if(event.key === 'ArrowUp') { event.preventDefault(); moveToPrevRow(input); }
    }

    function moveToNextCell(input) {
        const hour = parseInt(input.dataset.hour);
        const crewId = input.dataset.crewId;
        if(hour < 23) {
            const next = document.querySelector(`input[data-crew-id="${crewId}"][data-hour="${hour + 1}"]`);
            if(next) next.focus();
        }
    }
    function moveToPrevCell(input) {
        const hour = parseInt(input.dataset.hour);
        const crewId = input.dataset.crewId;
        if(hour > 0) {
            const prev = document.querySelector(`input[data-crew-id="${crewId}"][data-hour="${hour - 1}"]`);
            if(prev) prev.focus();
        }
    }
    function moveToNextRow(input) {
        const hour = input.dataset.hour;
        const row = input.closest('tr');
        let next = row.nextElementSibling;
        while(next && (next.classList.contains('section-row') || next.classList.contains('summary-row'))) {
            next = next.nextElementSibling;
        }
        if(next) {
            const nextInput = next.querySelector(`input[data-hour="${hour}"]`);
            if(nextInput) nextInput.focus();
        }
    }
    function moveToPrevRow(input) {
        const hour = input.dataset.hour;
        const row = input.closest('tr');
        let prev = row.previousElementSibling;
        while(prev && (prev.classList.contains('section-row') || prev.classList.contains('gc-row'))) {
            prev = prev.previousElementSibling;
        }
        if(prev) {
            const prevInput = prev.querySelector(`input[data-hour="${hour}"]`);
            if(prevInput) prevInput.focus();
        }
    }

    function updateCrewTotals(crewId, dateKey) {
        const entry = scheduleData[dateKey]?.[crewId];
        if(!entry) return;
        const hours = Object.keys(entry.hours).map(h => parseInt(h)).sort((a,b) => a-b);
        const total = hours.length;
        const totalCell = document.getElementById(`total-${crewId}`);
        if(totalCell) {
            if(total > 8) {
                // Overtime - red with warning
                totalCell.innerHTML = `<span style="color:#ef4444;font-weight:bold;">${total} ‚ö†Ô∏è</span>`;
                totalCell.title = `Overtime: ${total - 8} hour(s) over limit`;
            } else if(total === 8) {
                // At limit - yellow
                totalCell.innerHTML = `<span style="color:#fbbf24;font-weight:bold;">${total}</span>`;
                totalCell.title = 'At 8-hour limit';
            } else if(total > 0) {
                // Normal - green
                totalCell.innerHTML = `<span style="color:#10b981;">${total}</span>`;
                totalCell.title = '';
            } else {
                totalCell.textContent = '';
                totalCell.title = '';
            }
        }
        if(hours.length > 0) {
            entry.timeIn = formatHour(hours[0]);
            entry.timeOut = formatHour((hours[hours.length - 1] + 1) % 24);
            const timeCell = document.getElementById(`time-${crewId}`);
            if(timeCell) timeCell.textContent = `${entry.timeIn}-${entry.timeOut}`;
        } else {
            entry.timeIn = '';
            entry.timeOut = '';
            const timeCell = document.getElementById(`time-${crewId}`);
            if(timeCell) timeCell.textContent = '';
        }
    }

    function updateHourCounts(dateKey) {
        const daySchedule = scheduleData[dateKey] || {};
        for(let h = 0; h <= 23; h++) {
            let count = 0;
            Object.values(daySchedule).forEach(entry => { if(entry.hours?.[h]) count++; });
            const cell = document.getElementById(`hourcount-${h}`);
            if(cell) cell.textContent = count;
        }
    }

    function openAddCrewToSchedule(section) {
        const dateKey = currentDate.toISOString().split('T')[0];
        if(!scheduleData[dateKey]) scheduleData[dateKey] = {};
        
        // Generate a temporary ID for the new crew entry
        const tempId = 'temp_' + Date.now();
        
        // Add empty entry to schedule
        scheduleData[dateKey][tempId] = { 
            hours: {}, 
            station: '', 
            timeIn: '', 
            timeOut: '', 
            meal: '',
            tempName: '',
            section: section,
            isTemp: true
        };
        
        // Re-render to show the new row
        renderDaily();
        
        // Focus on the name input of the new row
        setTimeout(() => {
            const nameInput = document.querySelector(`input[data-temp-id="${tempId}"]`);
            if(nameInput) nameInput.focus();
        }, 100);
    }
    
    function updateTempCrewName(input, tempId) {
        const dateKey = currentDate.toISOString().split('T')[0];
        if(!scheduleData[dateKey] || !scheduleData[dateKey][tempId]) return;
        
        const enteredName = input.value.trim().toUpperCase();
        scheduleData[dateKey][tempId].tempName = enteredName;
        
        if(!enteredName) return;
        
        // Check if this crew name is already scheduled today
        const existingEntry = findExistingCrewSchedule(dateKey, enteredName, tempId);
        
        if(existingEntry) {
            const stationName = existingEntry.station ? getStationName(existingEntry.station) : 'a station';
            const hours = Object.keys(existingEntry.hours || {}).length;
            
            const proceed = confirm(
                `‚ö†Ô∏è DUPLICATE SCHEDULE ALERT!\n\n` +
                `"${enteredName}" is already scheduled today:\n` +
                `‚Ä¢ Station: ${stationName}\n` +
                `‚Ä¢ Hours: ${hours}\n` +
                `‚Ä¢ Time: ${existingEntry.timeIn || '?'} - ${existingEntry.timeOut || '?'}\n\n` +
                `Do you want to proceed anyway?\n\n` +
                `Click OK to add duplicate entry.\n` +
                `Click Cancel to change the name.`
            );
            
            if(!proceed) {
                input.value = '';
                scheduleData[dateKey][tempId].tempName = '';
                input.focus();
                return;
            }
        }
    }
    
    function findExistingCrewSchedule(dateKey, crewName, excludeTempId = null) {
        const daySchedule = scheduleData[dateKey] || {};
        
        // Check regular crew by name
        for(const crew of crewData) {
            if(crew.name.toUpperCase() === crewName && daySchedule[crew.id]) {
                const entry = daySchedule[crew.id];
                if(Object.keys(entry.hours || {}).length > 0) {
                    return entry;
                }
            }
        }
        
        // Check temp entries by tempName
        for(const [entryId, entry] of Object.entries(daySchedule)) {
            if(entryId === excludeTempId) continue;
            if(entry.isTemp && entry.tempName?.toUpperCase() === crewName) {
                if(Object.keys(entry.hours || {}).length > 0) {
                    return entry;
                }
            }
        }
        
        return null;
    }
    
    function updateTempCrewStation(input, tempId) {
        const dateKey = currentDate.toISOString().split('T')[0];
        if(scheduleData[dateKey] && scheduleData[dateKey][tempId]) {
            scheduleData[dateKey][tempId].station = input.value;
        }
    }
    
    function removeTempCrew(tempId) {
        const dateKey = currentDate.toISOString().split('T')[0];
        if(scheduleData[dateKey] && scheduleData[dateKey][tempId]) {
            delete scheduleData[dateKey][tempId];
            renderDaily();
        }
    }
    
    // Function to reset all data (useful if localStorage has issues)
    function resetAllData() {
        if(confirm('This will clear all saved data and reset to defaults. Continue?')) {
            localStorage.clear();
            location.reload();
        }
    }
    window.resetAllData = resetAllData;

    function prevDay() { currentDate.setDate(currentDate.getDate() - 1); document.getElementById('dateSelect').value = currentDate.toISOString().split('T')[0]; renderAll(); }
    function nextDay() { currentDate.setDate(currentDate.getDate() + 1); document.getElementById('dateSelect').value = currentDate.toISOString().split('T')[0]; renderAll(); }

    function renderMonthly() {
        const month = parseInt(document.getElementById('monthSelect').value);
        const year = parseInt(document.getElementById('yearSelect').value);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const dayNames = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
        
        // Header with day names
        let headHtml = '<tr><th class="name-col">NAME</th>';
        for(let d = 1; d <= daysInMonth; d++) {
            const dayOfWeek = new Date(year, month, d).getDay();
            const isWeekend = [0,6].includes(dayOfWeek);
            headHtml += `<th class="hour-col" style="${isWeekend?'background:#7c4a2d;':''}">${d}<br><span style="font-size:8px;font-weight:normal;">${dayNames[dayOfWeek]}</span></th>`;
        }
        headHtml += '<th style="min-width:50px;">TOTAL<br>HRS</th><th style="min-width:50px;">DAYS<br>WORKED</th><th style="min-width:50px;">MAX<br>STREAK</th><th style="min-width:60px;">VIOLATIONS</th></tr>';
        const monthlyHeadEl = document.getElementById('monthlyHead');
        if(monthlyHeadEl) monthlyHeadEl.innerHTML = headHtml;
        
        // Helper function to get streak from previous month end
        function getStreakFromPreviousMonth(crewId) {
            let streak = 0;
            // Go back up to 30 days to find the streak
            const firstDayOfMonth = new Date(year, month, 1);
            
            for(let i = 1; i <= 30; i++) {
                const checkDate = new Date(firstDayOfMonth);
                checkDate.setDate(checkDate.getDate() - i);
                const checkDateKey = checkDate.toISOString().split('T')[0];
                
                const entry = scheduleData[checkDateKey]?.[crewId];
                const hours = entry ? Object.keys(entry.hours || {}).length : 0;
                const isRest = restData[checkDateKey]?.[crewId] === true;
                
                if(hours > 0 && !isRest) {
                    streak++;
                } else {
                    break; // Streak broken
                }
            }
            return streak;
        }
        
        // Stats counters
        let totalViolations = 0;
        let crewWithViolations = 0;
        let totalHoursAll = 0;
        let totalDaysWorked = 0;
        let maxStreakOverall = 0;
        
        let bodyHtml = '';
        crewData.forEach(crew => {
            const isInactive = crew.status === 'inactive';
            const rowStyle = isInactive ? 'opacity:0.4;' : '';
            const nameStyle = isInactive ? 'text-decoration:line-through;color:#888;' : '';
            
            let totalHours = 0;
            let daysWorked = 0;
            let maxStreak = 0;
            let violations = 0;
            
            // Get streak carried over from previous month
            const previousMonthStreak = getStreakFromPreviousMonth(crew.id);
            let currentStreak = previousMonthStreak;
            
            // First pass: calculate hours, streaks, and violations for the month
            for(let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${year}-${(month+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const entry = scheduleData[dateKey]?.[crew.id];
                const hours = entry ? Object.keys(entry.hours||{}).length : 0;
                const isRest = restData[dateKey]?.[crew.id] === true;
                
                if(hours > 0 && !isRest) {
                    currentStreak++;
                    totalHours += hours;
                    daysWorked++;
                    if(currentStreak > maxStreak) maxStreak = currentStreak;
                    if(currentStreak >= 7) violations++;
                } else {
                    currentStreak = 0;
                }
            }
            
            // Track overall stats
            totalHoursAll += totalHours;
            totalDaysWorked += daysWorked;
            if(maxStreak > maxStreakOverall) maxStreakOverall = maxStreak;
            if(violations > 0) {
                totalViolations += violations;
                crewWithViolations++;
            }
            
            // Build row
            bodyHtml += `<tr style="${rowStyle}"><td class="name-cell" style="${nameStyle}">${crew.name}${isInactive ? ' <span style="font-size:8px;">[I]</span>' : ''}</td>`;
            
            // Reset streak to previous month value for display iteration
            currentStreak = previousMonthStreak;
            
            for(let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${year}-${(month+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const entry = scheduleData[dateKey]?.[crew.id];
                const hours = entry ? Object.keys(entry.hours||{}).length : 0;
                const isRest = restData[dateKey]?.[crew.id] === true;
                const isWeekend = [0,6].includes(new Date(year, month, d).getDay());
                
                if(hours > 0 && !isRest) {
                    currentStreak++;
                } else {
                    currentStreak = 0;
                }
                
                // Determine cell style based on streak
                let cellStyle = 'font-size:10px;text-align:center;';
                let cellContent = hours || '';
                
                if(isRest) {
                    cellStyle += 'background:rgba(239,68,68,0.2);color:#ef4444;';
                    cellContent = 'R';
                } else if(hours > 0) {
                    if(currentStreak >= 7) {
                        // 7th day or more - VIOLATION (red)
                        cellStyle += 'background:#ef4444;color:#fff;font-weight:bold;';
                        cellContent = `${hours}<sup style="font-size:7px;">‚ö†${currentStreak}</sup>`;
                    } else if(currentStreak === 6) {
                        // 6th day - CRITICAL (orange)
                        cellStyle += 'background:#f97316;color:#fff;font-weight:bold;';
                        cellContent = `${hours}<sup style="font-size:7px;">${currentStreak}</sup>`;
                    } else if(currentStreak === 5) {
                        // 5th day - WARNING (yellow)
                        cellStyle += 'background:#fbbf24;color:#000;font-weight:bold;';
                        cellContent = `${hours}<sup style="font-size:7px;">${currentStreak}</sup>`;
                    } else {
                        // Normal duty (green) - show streak if > 1
                        cellStyle += 'background:rgba(16,185,129,0.3);color:#4ade80;';
                        if(currentStreak > 1) {
                            cellContent = `${hours}<sup style="font-size:7px;">${currentStreak}</sup>`;
                        }
                    }
                } else if(isWeekend) {
                    cellStyle += 'background:rgba(255,193,7,0.1);';
                }
                
                bodyHtml += `<td style="${cellStyle}">${cellContent}</td>`;
            }
            
            // Summary columns
            const maxStreakStyle = maxStreak >= 7 ? 'color:#ef4444;font-weight:bold;' : (maxStreak >= 6 ? 'color:#f97316;font-weight:bold;' : (maxStreak >= 5 ? 'color:#fbbf24;' : 'color:#10b981;'));
            const violationStyle = violations > 0 ? 'background:#ef4444;color:#fff;font-weight:bold;' : 'color:#10b981;';
            
            bodyHtml += `<td class="total-cell">${totalHours}</td>`;
            bodyHtml += `<td style="text-align:center;">${daysWorked}</td>`;
            bodyHtml += `<td style="text-align:center;${maxStreakStyle}">${maxStreak}</td>`;
            bodyHtml += `<td style="text-align:center;${violationStyle}">${violations > 0 ? violations + ' ‚ö†Ô∏è' : '‚úì'}</td>`;
            bodyHtml += '</tr>';
        });
        
        const monthlyBodyEl = document.getElementById('monthlyBody');
        if(monthlyBodyEl) monthlyBodyEl.innerHTML = bodyHtml;
        
        // Update summary stats
        const activeCrew = crewData.filter(c => c.status !== 'inactive').length;
        const avgHoursPerCrew = activeCrew > 0 ? (totalHoursAll / activeCrew).toFixed(1) : 0;
        const avgDaysPerCrew = activeCrew > 0 ? (totalDaysWorked / activeCrew).toFixed(1) : 0;
        
        const monthlyStatsEl = document.getElementById('monthlyStats');
        if(monthlyStatsEl) monthlyStatsEl.innerHTML = `
            <div style="background:#1a1a2e;padding:12px;border-radius:8px;text-align:center;">
                <div style="font-size:24px;font-weight:bold;color:#10b981;">${totalHoursAll}</div>
                <div style="font-size:10px;color:#888;">Total Hours</div>
            </div>
            <div style="background:#1a1a2e;padding:12px;border-radius:8px;text-align:center;">
                <div style="font-size:24px;font-weight:bold;color:#3b82f6;">${avgHoursPerCrew}</div>
                <div style="font-size:10px;color:#888;">Avg Hours/Crew</div>
            </div>
            <div style="background:#1a1a2e;padding:12px;border-radius:8px;text-align:center;">
                <div style="font-size:24px;font-weight:bold;color:#fbbf24;">${avgDaysPerCrew}</div>
                <div style="font-size:10px;color:#888;">Avg Days/Crew</div>
            </div>
            <div style="background:#1a1a2e;padding:12px;border-radius:8px;text-align:center;">
                <div style="font-size:24px;font-weight:bold;color:${maxStreakOverall >= 7 ? '#ef4444' : '#f97316'};">${maxStreakOverall}</div>
                <div style="font-size:10px;color:#888;">Max Streak</div>
            </div>
            <div style="background:${totalViolations > 0 ? 'rgba(239,68,68,0.2)' : '#1a1a2e'};padding:12px;border-radius:8px;text-align:center;border:${totalViolations > 0 ? '2px solid #ef4444' : 'none'};">
                <div style="font-size:24px;font-weight:bold;color:${totalViolations > 0 ? '#ef4444' : '#10b981'};">${totalViolations > 0 ? totalViolations + ' ‚ö†Ô∏è' : '0 ‚úì'}</div>
                <div style="font-size:10px;color:#888;">7th Day Violations</div>
                ${crewWithViolations > 0 ? `<div style="font-size:9px;color:#ef4444;margin-top:4px;">${crewWithViolations} crew affected</div>` : ''}
            </div>
        `;
    }

    function renderRest() {
        const month = parseInt(document.getElementById('monthSelect').value);
        const year = parseInt(document.getElementById('yearSelect').value);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
        let headHtml = '<tr><th class="name-col">NAME</th>';
        for(let d = 1; d <= daysInMonth; d++) {
            const dayOfWeek = new Date(year, month, d).getDay();
            const isWeekend = [0,6].includes(dayOfWeek);
            const dayLabel = dayNames[dayOfWeek].charAt(0);
            headHtml += `<th class="hour-col ${isWeekend?'weekend':''}" title="${dayNames[dayOfWeek]}">${d}<br><span style="font-size:8px;font-weight:normal;">${dayLabel}</span></th>`;
        }
        headHtml += '<th style="min-width:50px;">TOTAL<br>REST</th></tr>';
        const restHeadEl = document.getElementById('restHead');
        if(restHeadEl) restHeadEl.innerHTML = headHtml;
        
        let bodyHtml = '';
        crewData.forEach(crew => {
            const isInactive = crew.status === 'inactive';
            const rowStyle = isInactive ? 'opacity:0.5;' : '';
            const nameStyle = isInactive ? 'text-decoration:line-through;color:#ef4444;' : '';
            
            let restCount = 0;
            bodyHtml += `<tr style="${rowStyle}"><td class="name-cell" style="${nameStyle}">${crew.name}${isInactive ? ' <span style="font-size:8px;">[I]</span>' : ''}</td>`;
            
            for(let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${year}-${(month+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const isRest = restData[dateKey]?.[crew.id] === true;
                const entry = scheduleData[dateKey]?.[crew.id];
                const isScheduled = entry && Object.keys(entry.hours||{}).length > 0;
                const isWeekend = [0,6].includes(new Date(year, month, d).getDay());
                
                // Count rest days (either marked as rest OR not scheduled)
                if(isRest) restCount++;
                
                // Determine cell display
                let cellContent = '';
                let cellClass = isWeekend ? 'weekend' : '';
                let cellStyle = 'cursor:pointer;';
                
                if(isRest) {
                    cellContent = 'R';
                    cellClass += ' rest-day';
                    cellStyle += 'background:rgba(239,68,68,0.3);color:#ef4444;font-weight:bold;';
                } else if(isScheduled) {
                    cellContent = '‚úì';
                    cellStyle += 'color:#10b981;';
                }
                
                bodyHtml += `<td class="${cellClass}" style="${cellStyle}" 
                    onclick="toggleRestDay(${crew.id}, '${dateKey}')" 
                    title="Click to toggle rest day">${cellContent}</td>`;
            }
            bodyHtml += `<td style="font-weight:600;text-align:center;background:rgba(239,68,68,0.1);color:#ef4444;">${restCount}</td></tr>`;
        });
        const restBodyEl = document.getElementById('restBody');
        if(restBodyEl) restBodyEl.innerHTML = bodyHtml;
    }
    
    function toggleRestDay(crewId, dateKey) {
        // Initialize date in restData if not exists
        if(!restData[dateKey]) restData[dateKey] = {};
        
        // Toggle rest status
        if(restData[dateKey][crewId]) {
            delete restData[dateKey][crewId];
            // Clean up empty dates
            if(Object.keys(restData[dateKey]).length === 0) {
                delete restData[dateKey];
            }
        } else {
            restData[dateKey][crewId] = true;
            
            // Also remove from schedule if scheduled
            if(scheduleData[dateKey]?.[crewId]) {
                delete scheduleData[dateKey][crewId];
            }
        }
        
        renderRest();
    }
    
    function saveRestData() {
        localStorage.setItem('restData', JSON.stringify(restData));
        saveRestToFirestore();
        showToast('‚úÖ Rest days saved!<br>‚òÅÔ∏è Synced to cloud', 'success');
    }
    window.saveRestData = saveRestData;
    
    function clearAllRest() {
        showConfirm('Clear All Rest Days', 'Are you sure you want to clear ALL rest days for this month?', function(confirmed) {
            if(confirmed) {
                const month = parseInt(document.getElementById('monthSelect').value);
                const year = parseInt(document.getElementById('yearSelect').value);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                // Remove rest data for this month
                for(let d = 1; d <= daysInMonth; d++) {
                    const dateKey = `${year}-${(month+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                    delete restData[dateKey];
                }
                
                renderRest();
                saveRestToFirestore();
                showToast('‚úÖ Rest days cleared for this month.<br>‚òÅÔ∏è Synced to cloud', 'success');
            }
        });
    }
    window.clearAllRest = clearAllRest;
    
    function isCrewOnRest(crewId, dateKey) {
        return restData[dateKey]?.[crewId] === true;
    }
    
    // Auto Rest Suggestion System
    let autoRestSuggestions = [];
    
    function openAutoRestModal() {
        const month = parseInt(document.getElementById('monthSelect').value);
        const year = parseInt(document.getElementById('yearSelect').value);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const today = new Date();
        
        autoRestSuggestions = [];
        
        let criticalCount = 0;
        let warningCount = 0;
        let upcomingCount = 0;
        
        // Analyze each crew
        crewData.forEach(crew => {
            if(crew.status === 'inactive') return;
            
            let currentStreak = 0;
            let streakStartDay = 0;
            
            // Scan through month
            for(let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${year}-${(month+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const entry = scheduleData[dateKey]?.[crew.id];
                const hours = entry ? Object.keys(entry.hours||{}).length : 0;
                const isRest = restData[dateKey]?.[crew.id] === true;
                const checkDate = new Date(year, month, d);
                const dayOfWeek = checkDate.getDay();
                
                if(hours > 0 && !isRest) {
                    if(currentStreak === 0) streakStartDay = d;
                    currentStreak++;
                    
                    // Check if we need to suggest rest
                    if(currentStreak >= 5) {
                        // Look ahead to find best rest day
                        const suggestDay = d + 1; // Suggest rest tomorrow
                        
                        if(suggestDay <= daysInMonth) {
                            const suggestDateKey = `${year}-${(month+1).toString().padStart(2,'0')}-${suggestDay.toString().padStart(2,'0')}`;
                            const alreadyResting = restData[suggestDateKey]?.[crew.id] === true;
                            const suggestDate = new Date(year, month, suggestDay);
                            const suggestDayOfWeek = suggestDate.getDay();
                            const suggestDayName = dayNames[suggestDayOfWeek];
                            
                            // Check crew's normal availability for that day
                            const availDays = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                            const crewAvail = crew.availability?.[availDays[suggestDayOfWeek]] || '';
                            const isNormalOff = crewAvail === '' || crewAvail.toUpperCase() === 'OFF';
                            
                            if(!alreadyResting && !isNormalOff) {
                                let urgency, urgencyLabel, urgencyColor;
                                
                                if(currentStreak >= 6) {
                                    urgency = 1;
                                    urgencyLabel = 'üî¥ CRITICAL';
                                    urgencyColor = '#ef4444';
                                    criticalCount++;
                                } else if(currentStreak === 5) {
                                    urgency = 2;
                                    urgencyLabel = 'üü† WARNING';
                                    urgencyColor = '#f97316';
                                    warningCount++;
                                } else {
                                    urgency = 3;
                                    urgencyLabel = 'üü° UPCOMING';
                                    urgencyColor = '#fbbf24';
                                    upcomingCount++;
                                }
                                
                                // Check if suggestion already exists for this crew on this day
                                const existingSuggestion = autoRestSuggestions.find(
                                    s => s.crewId === crew.id && s.dateKey === suggestDateKey
                                );
                                
                                if(!existingSuggestion) {
                                    autoRestSuggestions.push({
                                        crewId: crew.id,
                                        crewName: crew.name,
                                        dateKey: suggestDateKey,
                                        day: suggestDay,
                                        dayName: suggestDayName,
                                        currentStreak: currentStreak,
                                        urgency: urgency,
                                        urgencyLabel: urgencyLabel,
                                        urgencyColor: urgencyColor,
                                        reason: `${currentStreak} consecutive duty days (Day ${streakStartDay}-${d})`,
                                        selected: true
                                    });
                                }
                            }
                        }
                    }
                } else {
                    currentStreak = 0;
                }
            }
        });
        
        // Sort by urgency (critical first), then by date
        autoRestSuggestions.sort((a, b) => {
            if(a.urgency !== b.urgency) return a.urgency - b.urgency;
            return a.day - b.day;
        });
        
        // Render summary
        document.getElementById('autoRestSummary').innerHTML = `
            <div style="background:rgba(239,68,68,0.2);padding:12px;border-radius:8px;text-align:center;border:2px solid #ef4444;">
                <div style="font-size:24px;font-weight:bold;color:#ef4444;">${criticalCount}</div>
                <div style="font-size:10px;color:#ef4444;">üî¥ Critical</div>
                <div style="font-size:9px;color:#888;">Must rest immediately</div>
            </div>
            <div style="background:rgba(249,115,22,0.2);padding:12px;border-radius:8px;text-align:center;border:2px solid #f97316;">
                <div style="font-size:24px;font-weight:bold;color:#f97316;">${warningCount}</div>
                <div style="font-size:10px;color:#f97316;">üü† Warning</div>
                <div style="font-size:9px;color:#888;">At 5th day streak</div>
            </div>
            <div style="background:rgba(16,185,129,0.2);padding:12px;border-radius:8px;text-align:center;border:2px solid #10b981;">
                <div style="font-size:24px;font-weight:bold;color:#10b981;">${autoRestSuggestions.length}</div>
                <div style="font-size:10px;color:#10b981;">Total Suggestions</div>
                <div style="font-size:9px;color:#888;">Rest days to apply</div>
            </div>
        `;
        
        // Render suggestions
        if(autoRestSuggestions.length === 0) {
            document.getElementById('autoRestSuggestions').innerHTML = `
                <div style="text-align:center;padding:40px;color:#10b981;">
                    <div style="font-size:48px;margin-bottom:10px;">‚úì</div>
                    <div style="font-size:18px;font-weight:bold;">All Good!</div>
                    <div style="font-size:12px;color:#888;margin-top:10px;">No rest suggestions needed. All crew are within safe duty streak limits.</div>
                </div>
            `;
        } else {
            let suggestHtml = '<div style="display:flex;flex-direction:column;gap:8px;">';
            
            autoRestSuggestions.forEach((suggestion, idx) => {
                suggestHtml += `
                    <div style="background:#1a1a2e;padding:12px;border-radius:8px;border-left:4px solid ${suggestion.urgencyColor};display:flex;align-items:center;gap:15px;">
                        <input type="checkbox" id="suggest-${idx}" ${suggestion.selected ? 'checked' : ''} 
                            onchange="toggleSuggestion(${idx})"
                            style="width:20px;height:20px;cursor:pointer;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px;">
                                <span style="font-weight:bold;color:#fff;">${suggestion.crewName}</span>
                                <span style="font-size:10px;padding:2px 8px;background:${suggestion.urgencyColor};color:#fff;border-radius:10px;">${suggestion.urgencyLabel}</span>
                            </div>
                            <div style="font-size:11px;color:#888;">
                                Suggest rest on <strong style="color:#fbbf24;">${suggestion.dayName}, Day ${suggestion.day}</strong> 
                                ‚Äî ${suggestion.reason}
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:20px;font-weight:bold;color:${suggestion.urgencyColor};">${suggestion.currentStreak}</div>
                            <div style="font-size:9px;color:#888;">day streak</div>
                        </div>
                    </div>
                `;
            });
            
            suggestHtml += '</div>';
            document.getElementById('autoRestSuggestions').innerHTML = suggestHtml;
        }
        
        document.getElementById('autoRestModal').style.display = 'flex';
    }
    
    function toggleSuggestion(idx) {
        autoRestSuggestions[idx].selected = !autoRestSuggestions[idx].selected;
    }
    
    function selectAllSuggestions() {
        const allSelected = autoRestSuggestions.every(s => s.selected);
        autoRestSuggestions.forEach((s, idx) => {
            s.selected = !allSelected;
            const checkbox = document.getElementById(`suggest-${idx}`);
            if(checkbox) checkbox.checked = s.selected;
        });
    }
    
    function applySelectedRestSuggestions() {
        const selected = autoRestSuggestions.filter(s => s.selected);
        
        if(selected.length === 0) {
            alert('No suggestions selected. Please select at least one rest day to apply.');
            return;
        }
        
        if(!confirm(`Apply ${selected.length} rest day suggestion(s)?\n\nThis will mark the selected days as rest days in the Rest Calendar.`)) {
            return;
        }
        
        // Apply selected suggestions
        selected.forEach(suggestion => {
            if(!restData[suggestion.dateKey]) restData[suggestion.dateKey] = {};
            restData[suggestion.dateKey][suggestion.crewId] = true;
            
            // Also remove from schedule if scheduled
            if(scheduleData[suggestion.dateKey]?.[suggestion.crewId]) {
                delete scheduleData[suggestion.dateKey][suggestion.crewId];
            }
        });
        
        // Save and refresh
        saveToLocalStorage();
        closeModal('autoRestModal');
        renderMonthly();
        renderRest();
        
        alert(`‚úÖ Applied ${selected.length} rest day(s) successfully!\n\nThe Rest Calendar has been updated.`);
    }

    function renderCrew() {
        let html = '';
        const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
        
        // Position colors
        const positionColors = {
            'Crew': '#6b7280',
            'Crew Trainer': '#f59e0b',
            'Gel': '#10b981',
            'Maintenance': '#3b82f6'
        };
        
        crewData.forEach((crew, idx) => {
            const avail = crew.availability || {};
            const isActive = crew.status !== 'inactive';
            const rowStyle = isActive ? '' : 'opacity:0.5;background:rgba(239,68,68,0.1);';
            const nameStyle = isActive ? '' : 'text-decoration:line-through;color:#ef4444;';
            const shiftPref = crew.shiftPreference || 'any';
            const hourlyRate = crew.hourlyRate || 62.50;
            const position = crew.position || 'Crew';
            const posColor = positionColors[position] || '#6b7280';
            
            html += `<tr style="${rowStyle}" data-crew-idx="${idx}">`;
            
            // Checkbox for selection
            html += `<td style="text-align:center;">
                <input type="checkbox" class="crew-select-cb" data-crew-idx="${idx}" onchange="updateSelectedCount()">
            </td>`;
            
            // Editable Name
            html += `<td class="name-cell" style="${nameStyle}">
                <input type="text" value="${crew.name}" 
                    onchange="updateCrewField(${idx}, 'name', this.value)"
                    style="background:transparent;border:none;color:inherit;width:100%;padding:4px;font-size:12px;font-weight:600;text-decoration:inherit;">
            </td>`;
            
            // Position dropdown
            html += `<td style="padding:2px;">
                <select onchange="updateCrewField(${idx}, 'position', this.value)"
                    style="width:100%;padding:4px;background:#12121f;border:1px solid ${posColor};color:${posColor};border-radius:4px;font-size:9px;font-weight:600;">
                    <option value="Crew" ${position==='Crew'?'selected':''}>Crew</option>
                    <option value="Crew Trainer" ${position==='Crew Trainer'?'selected':''}>‚≠ê Crew Trainer</option>
                    <option value="Gel" ${position==='Gel'?'selected':''}>üîß Gel</option>
                    <option value="Maintenance" ${position==='Maintenance'?'selected':''}>üõ†Ô∏è Maintenance</option>
                </select>
            </td>`;
            
            // Status toggle (Active/Inactive)
            html += `<td style="text-align:center;">
                <button onclick="toggleCrewStatus(${idx})" 
                    style="padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:10px;font-weight:600;width:100%;
                    background:${isActive ? '#10b981' : '#ef4444'};color:#fff;">
                    ${isActive ? '‚úì Active' : '‚úó Inactive'}
                </button>
            </td>`;
            
            // Shift Preference dropdown
            const shiftColors = {
                'any': '#6b7280',
                'morning': '#fbbf24',
                'mid': '#10b981',
                'evening': '#3b82f6',
                'graveyard': '#8b5cf6'
            };
            html += `<td style="padding:2px;">
                <select onchange="updateCrewField(${idx}, 'shiftPreference', this.value)"
                    style="width:100%;padding:4px;background:#12121f;border:1px solid ${shiftColors[shiftPref]};color:${shiftColors[shiftPref]};border-radius:4px;font-size:9px;">
                    <option value="any" ${shiftPref==='any'?'selected':''}>Any</option>
                    <option value="morning" ${shiftPref==='morning'?'selected':''}>üåÖ Morning</option>
                    <option value="mid" ${shiftPref==='mid'?'selected':''}>‚òÄÔ∏è Mid</option>
                    <option value="evening" ${shiftPref==='evening'?'selected':''}>üåÜ Evening</option>
                    <option value="graveyard" ${shiftPref==='graveyard'?'selected':''}>üåô Graveyard</option>
                </select>
            </td>`;
            
            // Hourly Rate
            html += `<td style="padding:2px;">
                <input type="number" value="${hourlyRate.toFixed(2)}" min="0" step="0.50"
                    onchange="updateCrewField(${idx}, 'hourlyRate', parseFloat(this.value) || 62.50)"
                    style="width:100%;padding:4px;background:#12121f;border:1px solid #10b981;border-radius:4px;color:#10b981;font-size:11px;text-align:right;">
            </td>`;
            
            // Editable Stations - clickable to open modal
            const stationNames = (crew.stations || []).map(s => getStationName(s)).join(', ');
            html += `<td style="font-size:10px;text-align:left;padding:4px;">
                <div onclick="openEditStationsModal(${idx})" 
                    style="cursor:pointer;padding:6px;background:#12121f;border-radius:4px;min-height:30px;border:1px dashed #444;">
                    ${stationNames || '<span style="color:#666;">Click to edit...</span>'}
                </div>
            </td>`;
            
            // Editable Availability for each day
            days.forEach(day => {
                const val = avail[day] || '';
                const displayVal = val === '' ? 'OFF' : val;
                const cellStyle = val === '' || val.toUpperCase() === 'OFF' ? 'color:#ef4444;' : 'color:#10b981;';
                html += `<td style="padding:2px;">
                    <input type="text" value="${displayVal}" 
                        onchange="updateCrewAvailability(${idx}, '${day}', this.value)"
                        onclick="this.select()"
                        placeholder="OFF"
                        style="width:100%;padding:4px;background:#12121f;border:1px solid #333;border-radius:4px;${cellStyle}font-size:9px;text-align:center;">
                </td>`;
            });
            
            // Actions
            html += `<td style="text-align:center;">
                <button onclick="deleteCrew(${idx})" 
                    style="padding:4px 8px;border:none;border-radius:4px;cursor:pointer;font-size:10px;background:#ef4444;color:#fff;"
                    title="Delete Crew">üóëÔ∏è</button>
            </td>`;
            
            html += '</tr>';
        });
        
        const crewBodyEl = document.getElementById('crewBody');
        if(crewBodyEl) crewBodyEl.innerHTML = html;
        updateSelectedCount();
    }
    
    function toggleSelectAllCrew(checkbox) {
        const checkboxes = document.querySelectorAll('.crew-select-cb');
        checkboxes.forEach(cb => cb.checked = checkbox.checked);
        updateSelectedCount();
    }
    
    function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('.crew-select-cb:checked');
        const countEl = document.getElementById('selectedCount');
        if(countEl) countEl.textContent = `${checkboxes.length} selected`;
    }
    
    // Make functions globally accessible
    window.toggleSelectAllCrew = toggleSelectAllCrew;
    window.updateSelectedCount = updateSelectedCount;
    
    function applyRateToSelected() {
        console.log('applyRateToSelected called');
        const bulkInput = document.getElementById('bulkRateInput');
        const rate = parseFloat(bulkInput?.value) || 62.50;
        console.log('rate:', rate);
        const checkboxes = document.querySelectorAll('.crew-select-cb:checked');
        console.log('checked boxes:', checkboxes.length);
        
        if(checkboxes.length === 0) {
            alert('‚ö†Ô∏è No crew selected. Please select crew members first.');
            return;
        }
        
        console.log('Applying rates...');
        let count = 0;
        checkboxes.forEach(cb => {
            const idx = parseInt(cb.dataset.crewIdx);
            console.log('Applying rate', rate, 'to crew index:', idx, 'name:', crewData[idx]?.name);
            if(crewData[idx]) {
                crewData[idx].hourlyRate = rate;
                count++;
            }
        });
        
        console.log('Applied to', count, 'crew members');
        
        renderCrew();
        saveCrewData();
        alert('‚úÖ Applied ‚Ç±' + rate.toFixed(2) + '/hr to ' + count + ' crew member(s).');
    }
    
    function applyRateToAll() {
        console.log('applyRateToAll called');
        const bulkInput = document.getElementById('bulkRateInput');
        const rate = parseFloat(bulkInput?.value) || 62.50;
        console.log('rate:', rate);
        
        console.log('Applying rates to all...');
        let count = 0;
        for(let i = 0; i < crewData.length; i++) {
            console.log('Applying rate', rate, 'to:', crewData[i].name);
            crewData[i].hourlyRate = rate;
            count++;
        }
        
        console.log('Applied to', count, 'crew members');
        
        renderCrew();
        saveCrewData();
        alert('‚úÖ Applied ‚Ç±' + rate.toFixed(2) + '/hr to all ' + count + ' crew members.');
    }
    
    // Make functions globally accessible
    window.applyRateToSelected = applyRateToSelected;
    window.applyRateToAll = applyRateToAll;
    
    function toggleCrewStatus(idx) {
        if(crewData[idx].status === 'inactive') {
            crewData[idx].status = 'active';
        } else {
            crewData[idx].status = 'inactive';
        }
        renderCrew();
        saveCrewData();
    }
    window.toggleCrewStatus = toggleCrewStatus;
    
    function updateCrewField(idx, field, value) {
        // Handle numeric fields differently (don't uppercase)
        if(field === 'hourlyRate') {
            crewData[idx][field] = parseFloat(value) || 62.50;
        } else if(field === 'shiftPreference' || field === 'position') {
            crewData[idx][field] = value; // Keep as-is for dropdown values
        } else {
            crewData[idx][field] = typeof value === 'string' ? value.toUpperCase() : value;
        }
        renderCrew();
    }
    window.updateCrewField = updateCrewField;
    
    function updateCrewAvailability(idx, day, value) {
        if(!crewData[idx].availability) crewData[idx].availability = {};
        // Normalize input
        const upper = value.toUpperCase().trim();
        if(upper === 'OFF' || upper === '' || upper === '-') {
            crewData[idx].availability[day] = '';
        } else {
            crewData[idx].availability[day] = upper;
        }
        renderCrew();
    }
    window.updateCrewAvailability = updateCrewAvailability;
    
    function deleteCrew(idx) {
        const crew = crewData[idx];
        showConfirm(
            'Delete Crew Member',
            `Are you sure you want to delete "${crew.name}"? This cannot be undone.`,
            function(confirmed) {
                if(confirmed) {
                    const crewName = crew.name;
                    crewData.splice(idx, 1);
                    renderCrew();
                    saveToLocalStorage();
                    showToast(`üóëÔ∏è Crew "${crewName}" deleted!`, 'success');
                }
            }
        );
    }
    window.deleteCrew = deleteCrew;
    
    function saveCrewData() {
        saveToLocalStorage();
        saveCrewToFirestore();
        showToast('‚úÖ Crew data saved!<br>‚òÅÔ∏è Synced to cloud', 'success');
    }
    window.saveCrewData = saveCrewData;
    
    function openEditStationsModal(idx) {
        const crew = crewData[idx];
        currentEditingCrewIdx = idx;
        
        // Build station checkboxes
        let html = `<p style="margin-bottom:15px;color:#888;">Select stations that <strong>${crew.name}</strong> is trained for:</p>`;
        html += '<div style="max-height:400px;overflow-y:auto;">';
        
        Object.entries(AREAS).forEach(([areaId, area]) => {
            const stations = stationsData[areaId] || [];
            if(stations.length === 0) return;
            
            html += `<div style="margin-bottom:15px;">
                <h4 style="color:${area.color};font-size:12px;margin-bottom:8px;">${area.icon} ${area.name}</h4>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:5px;">`;
            
            stations.forEach(station => {
                const isChecked = (crew.stations || []).includes(station.id);
                html += `<label style="display:flex;align-items:center;gap:8px;padding:6px;background:#12121f;border-radius:4px;cursor:pointer;font-size:11px;">
                    <input type="checkbox" value="${station.id}" ${isChecked ? 'checked' : ''} 
                        onchange="toggleCrewStation(${idx}, '${station.id}', this.checked)">
                    ${station.name}
                </label>`;
            });
            
            html += '</div></div>';
        });
        
        html += '</div>';
        
        document.getElementById('editStationsContent').innerHTML = html;
        document.getElementById('editStationsModal').style.display = 'flex';
    }
    window.openEditStationsModal = openEditStationsModal;
    
    function toggleCrewStation(idx, stationId, checked) {
        if(!crewData[idx].stations) crewData[idx].stations = [];
        
        if(checked) {
            if(!crewData[idx].stations.includes(stationId)) {
                crewData[idx].stations.push(stationId);
            }
        } else {
            crewData[idx].stations = crewData[idx].stations.filter(s => s !== stationId);
        }
    }
    window.toggleCrewStation = toggleCrewStation;
    
    function closeEditStationsModal() {
        document.getElementById('editStationsModal').style.display = 'none';
        renderCrew();
    }
    window.closeEditStationsModal = closeEditStationsModal;
    
    let currentEditingCrewIdx = null;

    function renderReports() {
        const month = parseInt(document.getElementById('monthSelect').value);
        const year = parseInt(document.getElementById('yearSelect').value);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        let html = '';
        crewData.forEach(crew => {
            let totalHours = 0, daysWorked = 0;
            for(let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${year}-${(month+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const entry = scheduleData[dateKey]?.[crew.id];
                if(entry) {
                    const hrs = Object.keys(entry.hours||{}).length;
                    if(hrs > 0) { totalHours += hrs; daysWorked++; }
                }
            }
            html += `<tr>
                <td class="name-cell">${crew.name}</td>
                <td>${crew.section}</td>
                <td class="total-cell">${totalHours}</td>
                <td>${daysWorked}</td>
                <td>${daysInMonth - daysWorked}</td>
                <td>${daysWorked > 0 ? (totalHours / daysWorked).toFixed(1) : '0'}</td>
            </tr>`;
        });
        const reportBodyEl = document.getElementById('reportBody');
        if(reportBodyEl) reportBodyEl.innerHTML = html;
    }

    function exportToExcel() {
        const table = document.querySelector('.content > section:not([style*="none"]) table');
        if(!table) return;
        const wb = XLSX.utils.table_to_book(table, { sheet: 'Schedule' });
        XLSX.writeFile(wb, `CrewSchedule_${currentDate.toISOString().split('T')[0]}.xlsx`);
    }
    
    // Download Daily Schedule to Excel
    function downloadScheduleExcel() {
        const dateKey = currentDate.toISOString().split('T')[0];
        const daySchedule = scheduleData[dateKey] || {};
        const dayGC = gcForecast[dateKey] || {};
        const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        const daysOfWeek = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        
        // Section colors matching the app
        const sectionColors = {
            'PRODUCTION': { bg: '#ef4444', text: '#ffffff' },
            'SERVICE': { bg: '#3b82f6', text: '#ffffff' },
            'DRIVE THRU': { bg: '#10b981', text: '#ffffff' },
            'BEVCEL_FRIES': { bg: '#f97316', text: '#ffffff' },
            'CUSTOMER_AREA': { bg: '#06b6d4', text: '#ffffff' },
            'MDS': { bg: '#a855f7', text: '#ffffff' },
            'MARKETING': { bg: '#fbbf24', text: '#000000' },
            'OTHERS': { bg: '#6b7280', text: '#ffffff' }
        };
        
        // Build HTML table for Excel
        let html = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel">
        <head>
            <meta charset="UTF-8">
            <style>
                table { border-collapse: collapse; font-family: Arial, sans-serif; }
                th, td { border: 1px solid #333; padding: 4px 6px; text-align: center; font-size: 11px; }
                .title { font-size: 16px; font-weight: bold; background: #1a1a2e; color: #ffffff; }
                .header { background: #1e293b; color: #ffffff; font-weight: bold; }
                .gc-row { background: #fbbf24; color: #000000; font-weight: bold; }
                .section-production { background: #fef2f2; }
                .section-service { background: #eff6ff; }
                .section-drivethru { background: #ecfdf5; }
                .section-bevcel { background: #fff7ed; }
                .section-customer { background: #ecfeff; }
                .section-mds { background: #faf5ff; }
                .section-marketing { background: #fefce8; }
                .section-others { background: #f9fafb; }
                .filled { background: #10b981; color: #ffffff; font-weight: bold; }
                .name-cell { text-align: left; font-weight: bold; }
                .total-row { background: #1e293b; color: #ffffff; font-weight: bold; }
                .section-header { font-weight: bold; color: #ffffff; }
            </style>
        </head>
        <body>
        <table>
        `;
        
        // Title row
        html += `<tr><td colspan="30" class="title">üìã Crew Scheduling - ${daysOfWeek[currentDate.getDay()]}, ${months[currentDate.getMonth()]} ${currentDate.getDate()}, ${currentDate.getFullYear()}</td></tr>`;
        html += `<tr><td colspan="30"></td></tr>`;
        
        // Header row
        html += `<tr class="header">
            <th>NAME</th>
            <th>SECTION</th>
            <th>STATION</th>
            <th>TOTAL HRS</th>
            <th>TIME</th>
            <th>MEAL</th>`;
        for(let h = 0; h <= 23; h++) {
            const label = h === 0 ? '12AM' : (h < 12 ? h + 'AM' : (h === 12 ? '12PM' : (h-12) + 'PM'));
            html += `<th>${label}</th>`;
        }
        html += `</tr>`;
        
        // GC Row
        const totalGC = Object.values(dayGC).reduce((a,b) => a + (parseInt(b) || 0), 0);
        html += `<tr class="gc-row">
            <td class="name-cell">üìä GC FORECAST</td>
            <td></td>
            <td></td>
            <td>${totalGC}</td>
            <td></td>
            <td></td>`;
        for(let h = 0; h <= 23; h++) {
            html += `<td>${dayGC[h] || ''}</td>`;
        }
        html += `</tr>`;
        
        // Crew by section
        const sections = ['PRODUCTION', 'SERVICE', 'DRIVE THRU', 'BEVCEL_FRIES', 'CUSTOMER_AREA', 'MDS', 'MARKETING', 'OTHERS'];
        const sectionLabels = {
            'PRODUCTION': 'üî¥ PRODUCTION',
            'SERVICE': 'üîµ SERVICE',
            'DRIVE THRU': 'üü¢ DRIVE THRU',
            'BEVCEL_FRIES': 'üü† BEVCEL & FRIES',
            'CUSTOMER_AREA': 'ü©µ CUSTOMER AREA',
            'MDS': 'üü£ MDS/3PO',
            'MARKETING': 'üü° MARKETING',
            'OTHERS': '‚ö™ OTHERS'
        };
        const sectionClasses = {
            'PRODUCTION': 'section-production',
            'SERVICE': 'section-service',
            'DRIVE THRU': 'section-drivethru',
            'BEVCEL_FRIES': 'section-bevcel',
            'CUSTOMER_AREA': 'section-customer',
            'MDS': 'section-mds',
            'MARKETING': 'section-marketing',
            'OTHERS': 'section-others'
        };
        
        sections.forEach(section => {
            const sectionCrew = crewData.filter(c => c.section === section);
            const scheduledCrew = sectionCrew.filter(c => {
                const entry = daySchedule[c.id];
                return entry && Object.keys(entry.hours || {}).length > 0;
            });
            
            // Manual entries
            const manualEntries = Object.entries(daySchedule).filter(([id, entry]) => {
                return entry.isTemp && entry.section === section;
            });
            
            if(scheduledCrew.length === 0 && manualEntries.length === 0) return;
            
            // Section header row
            const colors = sectionColors[section] || { bg: '#6b7280', text: '#ffffff' };
            html += `<tr><td colspan="30" class="section-header" style="background:${colors.bg};color:${colors.text};">${sectionLabels[section] || section}</td></tr>`;
            
            const rowClass = sectionClasses[section] || '';
            
            scheduledCrew.forEach(crew => {
                const entry = daySchedule[crew.id];
                const totalHours = Object.keys(entry.hours || {}).length;
                const stationName = getStationName(entry.station) || '';
                const position = crew.position || 'Crew';
                const positionBadge = position === 'Crew Trainer' ? '‚≠ê ' : '';
                
                html += `<tr class="${rowClass}">
                    <td class="name-cell">${positionBadge}${crew.name}</td>
                    <td>${section}</td>
                    <td>${stationName}</td>
                    <td style="background:#dbeafe;font-weight:bold;">${totalHours}</td>
                    <td>${entry.timeIn || ''}-${entry.timeOut || ''}</td>
                    <td style="${entry.meal === 'A' ? 'background:#10b981;color:#fff;' : entry.meal === 'B' ? 'background:#3b82f6;color:#fff;' : ''}">${entry.meal || ''}</td>`;
                
                for(let h = 0; h <= 23; h++) {
                    if(entry.hours?.[h]) {
                        html += `<td class="filled">‚óè</td>`;
                    } else {
                        html += `<td></td>`;
                    }
                }
                html += `</tr>`;
            });
            
            // Manual entries
            manualEntries.forEach(([id, entry]) => {
                const totalHours = Object.keys(entry.hours || {}).length;
                
                html += `<tr class="${rowClass}">
                    <td class="name-cell">${entry.tempName || 'Manual'}</td>
                    <td>${section}</td>
                    <td>${entry.station || ''}</td>
                    <td style="background:#dbeafe;font-weight:bold;">${totalHours}</td>
                    <td>${entry.timeIn || ''}-${entry.timeOut || ''}</td>
                    <td></td>`;
                
                for(let h = 0; h <= 23; h++) {
                    if(entry.hours?.[h]) {
                        html += `<td class="filled">‚óè</td>`;
                    } else {
                        html += `<td></td>`;
                    }
                }
                html += `</tr>`;
            });
        });
        
        // Empty row before total
        html += `<tr><td colspan="30"></td></tr>`;
        
        // Total crew per hour row
        html += `<tr class="total-row">
            <td class="name-cell">TOTAL CREW PER HOUR</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>`;
        for(let h = 0; h <= 23; h++) {
            let count = 0;
            Object.values(daySchedule).forEach(entry => {
                if(entry.hours?.[h]) count++;
            });
            html += `<td>${count || ''}</td>`;
        }
        html += `</tr>`;
        
        html += `</table></body></html>`;
        
        // Create blob and download
        const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `CrewSchedule_${dateKey}.xls`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('‚úÖ Excel file downloaded!<br>üì• CrewSchedule_' + dateKey + '.xls', 'success');
    }
    
    // Make function globally accessible
    window.downloadScheduleExcel = downloadScheduleExcel;

    // ==================== LOGIN SYSTEM ====================
    
    // Load users from localStorage or use defaults
    function getUsers() {
        const savedUsers = localStorage.getItem('crewSchedulerUsers');
        if(savedUsers) {
            return JSON.parse(savedUsers);
        }
        // Default users
        return {
            'admin': { password: 'admin123', role: 'admin', name: 'Administrator' },
            'manager': { password: 'manager123', role: 'manager', name: 'Store Manager' },
            'crew': { password: 'crew123', role: 'crew', name: 'Crew Member' }
        };
    }
    
    function saveUsers(users) {
        localStorage.setItem('crewSchedulerUsers', JSON.stringify(users));
    }
    
    let currentUser = null;
    
    function handleLogin(event) {
        event.preventDefault();
        
        const username = document.getElementById('loginUsername').value.trim().toLowerCase();
        const password = document.getElementById('loginPassword').value;
        const errorEl = document.getElementById('loginError');
        const users = getUsers();
        
        // Check credentials
        if(users[username] && users[username].password === password) {
            currentUser = {
                username: username,
                role: users[username].role,
                name: users[username].name
            };
            
            // Save session
            localStorage.setItem('crewSchedulerSession', JSON.stringify(currentUser));
            
            // Hide login, show app
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.add('visible');
            
            // Initialize app
            init();
            
            // Show welcome toast
            setTimeout(() => {
                showToast(`üëã Welcome, ${currentUser.name}!`, 'success');
            }, 500);
        } else {
            // Show error
            errorEl.classList.add('show');
            document.getElementById('loginPassword').value = '';
            
            // Hide error after 3 seconds
            setTimeout(() => errorEl.classList.remove('show'), 3000);
        }
    }
    window.handleLogin = handleLogin;
    
    function logout() {
        showConfirm('Logout', 'Are you sure you want to logout?', function(confirmed) {
            if(confirmed) {
                currentUser = null;
                localStorage.removeItem('crewSchedulerSession');
                
                // Show login, hide app
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
                
                // Clear form
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
            }
        });
    }
    window.logout = logout;
    
    function openChangePassword() {
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        document.getElementById('passwordError').style.display = 'none';
        document.getElementById('passwordSuccess').style.display = 'none';
        document.getElementById('changePasswordModal').classList.add('show');
    }
    window.openChangePassword = openChangePassword;
    
    function changePassword() {
        const currentPwd = document.getElementById('currentPassword').value;
        const newPwd = document.getElementById('newPassword').value;
        const confirmPwd = document.getElementById('confirmPassword').value;
        const errorEl = document.getElementById('passwordError');
        const successEl = document.getElementById('passwordSuccess');
        
        errorEl.style.display = 'none';
        successEl.style.display = 'none';
        
        const users = getUsers();
        
        // Validate current password
        if(users[currentUser.username].password !== currentPwd) {
            errorEl.textContent = '‚ùå Current password is incorrect.';
            errorEl.style.display = 'block';
            return;
        }
        
        // Validate new password
        if(newPwd.length < 6) {
            errorEl.textContent = '‚ùå New password must be at least 6 characters.';
            errorEl.style.display = 'block';
            return;
        }
        
        // Validate confirmation
        if(newPwd !== confirmPwd) {
            errorEl.textContent = '‚ùå New passwords do not match.';
            errorEl.style.display = 'block';
            return;
        }
        
        // Update password
        users[currentUser.username].password = newPwd;
        saveUsers(users);
        saveUsersToFirestore();
        
        // Show success
        successEl.textContent = '‚úÖ Password changed successfully!';
        successEl.style.display = 'block';
        
        // Clear fields
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        
        // Close modal after 2 seconds
        setTimeout(() => {
            closeModal('changePasswordModal');
            showToast('‚úÖ Password changed!<br>‚òÅÔ∏è Synced to cloud', 'success');
        }, 1500);
    }
    window.changePassword = changePassword;
    
    function checkSession() {
        const session = localStorage.getItem('crewSchedulerSession');
        if(session) {
            try {
                currentUser = JSON.parse(session);
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                init();
            } catch(e) {
                localStorage.removeItem('crewSchedulerSession');
            }
        }
    }
    
    // Check for existing session on page load
    document.addEventListener('DOMContentLoaded', checkSession);
    </script>
    
</body>
</html>
